<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Android Jetpackç³»åˆ—å…¶äºŒlivedata]]></title>
    <url>%2F2019%2F11%2F07%2FJetpack-livedata%2F</url>
    <content type="text"><![CDATA[å‰è¨€livedataæ˜¯è¢«è§‚å¯Ÿè€…çš„æŒæœ‰ç±»ï¼Œå¹¶èƒ½æ„Ÿåº”ç”Ÿå‘½å‘¨æœŸã€‚æ­¤ç¯‡æ–‡ç« é‡åœ¨åˆ†æžä¸¤ç‚¹ livedataå¦‚ä½•å®žçŽ°è§‚å¯Ÿè€…æ¨¡å¼çš„ livedataæ˜¯å¦‚ä½•æ„ŸçŸ¥æ•°æ®æµçš„å˜åŒ–çš„ livedataæ˜¯å¦‚ä½•æ„ŸçŸ¥lifecycleOwnerçš„ç”Ÿå‘½å‘¨æœŸçš„ ä½¿ç”¨ä¸Žåˆ†æžlivedataä¸€èˆ¬æ˜¯é…åˆviewmodelä½¿ç”¨çš„ï¼Œé¦–å…ˆçœ‹çœ‹ä¸‹é¢çš„ä½¿ç”¨æ¡ˆä¾‹ class StoreViewModel: ViewModel { // åˆå§‹åŒ– val articles: MutableLiveData&lt;MutableList&lt;Article>> = MutableLiveData() fun loadArticles(page: Int) { // ç½‘ç»œè¯·æ±‚åº”æ”¾åœ¨å¯¹åº”repositoryä¸­ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿è¯´æ˜Ž CoroutineScope(Dispatchers.IO).launch { val articlesWrapper = apiCenter().homeArticles(page.toString()) // ä»ŽæœåŠ¡å™¨èŽ·å–æ•°æ® articles.postValue(articlesWrapper.data.datas.toMutableList()) } } } class HomeFragment : BaseFragment() { fun initialized() { vm.articles.observe(this, Observer&lt;MutableList&lt;Article>> { // é€šçŸ¥UIæ›´æ–° }) } } æŽ¥ä¸‹æ¥çœ‹çœ‹ï¼Œåœ¨livedataå†…éƒ¨æ˜¯å¦‚ä½•æ„ŸçŸ¥æ•°æ®æµå˜åŒ–çš„ // livedataçš„æž„é€ æ–¹æ³• public LiveData(T value) { mData = value; mVersion = START_VERSION + 1; } public LiveData() { mData = NOT_SET; mVersion = START_VERSION; } // å…¶ä¸­mDataå°±æ˜¯å­˜å‚¨çš„æ•°æ®äº†ï¼Œversionå¯ä»¥çœ‹åšå­˜å‚¨æ•°æ®çš„å½“å‰ç‰ˆæœ¬ protected void postValue(T value) { boolean postTask; synchronized (mDataLock) { postTask = mPendingData == NOT_SET; mPendingData = value; } if (!postTask) { return; } ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable); } // å‘é€æ•°æ®åˆ°ä¸»çº¿ç¨‹ï¼Œå¦‚æžœåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡ä¹‹å‰postValueå¤šæ¬¡ï¼Œé‚£ä¹ˆåªä¼šåˆ†å‘æœ€åŽä¸€æ¬¡çš„value // ArchTaskExecutor.getInstance().postToMainThreadå…¶å®žå°±æ˜¯è°ƒç”¨ä¸»çº¿ç¨‹çš„Handlerå°†valueä¼ é€’åˆ°ä¸»çº¿ç¨‹ private final Runnable mPostValueRunnable = new Runnable() { @Override public void run() { Object newValue; synchronized (mDataLock) { newValue = mPendingData; mPendingData = NOT_SET; } //noinspection unchecked setValue((T) newValue); } }; @MainThread protected void setValue(T value) { assertMainThread("setValue"); mVersion++; mData = value; dispatchingValue(null); } // åœ¨è¿™é‡Œä¼šç»™mDataé‡æ–°èµ‹å€¼ï¼Œç„¶åŽåšåˆ†å‘ // åœ¨MutableLiveDataä¸­çš„setValueå…¶å®žå°±æ˜¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­å¦‚æžœè¦ç›´æŽ¥ç»™livedataèµ‹å€¼ï¼Œå¯ä»¥ç›´æŽ¥è°ƒç”¨æ­¤æ–¹æ³• // å†æ¥çœ‹çœ‹livedataå†…éƒ¨çš„è§‚å¯Ÿè€… private SafeIterableMap&lt;Observer&lt;? super T>, ObserverWrapper> mObservers = new SafeIterableMap&lt;>(); // å®ƒå…¶å®žæ˜¯ä¸ªåŒå‘åˆ—è¡¨ æœ‰å¦‚ä¸‹ä¼˜ç‚¹ // 1.ç›´æŽ¥ç§»åŠ¨æŒ‡é’ˆæ’å…¥ä¸”æ— éœ€æ‰§è¡Œhashç®—æ³•æ•ˆçŽ‡é«˜ // 2.å¯ä»¥ä¸€è¾¹éåŽ†ä¸€éåˆ é™¤å…ƒç´ è€Œä¸ä¼šå¼•èµ·ConcurrentModifiedException // 3.ä½¿ç”¨åŒå‘é“¾è¡¨å­˜å‚¨æ•°æ®æ¯”HashMap(java8)æ›´èŠ‚çœç©ºé—´ // å‘livedataæ·»åŠ ä¸€ä¸ªè§‚å¯Ÿè€… @MainThread public void observe(@NonNull LifecycleOwner owner, @NonNull Observer&lt;? super T> observer) { assertMainThread("observe"); if (owner.getLifecycle().getCurrentState() == DESTROYED) { // ignore return; } LifecycleBoundObserver wrapper = new LifecycleBoundObserver(owner, observer); // å¦‚æžœMapä¸­ä¸å­˜åœ¨å°±æ”¾ç½®è¿›åŽ»å¹¶è¿”å›žNullï¼Œå¦‚æžœå­˜åœ¨ç›´æŽ¥æ‹¿å‡º ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper); if (existing != null &amp;&amp; !existing.isAttachedTo(owner)) { throw new IllegalArgumentException("Cannot add the same observer" + " with different lifecycles"); } if (existing != null) { return; } owner.getLifecycle().addObserver(wrapper); } // LifecycleBoundObserver ç”Ÿå‘½å‘¨æœŸè¾¹ç•Œçš„è§‚å¯Ÿè€… // LifecycleBoundObserver å®ƒæ—¢æ˜¯livedataäº‹ä»¶çš„è§‚å¯Ÿè€…åˆæ˜¯ç”Ÿå‘½å‘¨æœŸå˜åŒ–çš„è§‚å¯Ÿè€…ï¼Œæ¢å¥è¯æ¥è¯´ï¼Œå®ƒæ—¢èƒ½æ„ŸçŸ¥livedataæ•°æ®æµçš„å˜åŒ–ä¹Ÿèƒ½æ„ŸçŸ¥lifecycleOwnerç”Ÿå‘½å‘¨æœŸçš„å˜åŒ– // å®ƒè¢«æ·»åŠ åˆ°äº†mObserversä¸­ä¹Ÿè¢«æ·»åŠ åˆ°äº†LifecycleRegistryçš„mObserverMap: FastSafeIterableMapä¸­ // å†æ¥çœ‹çœ‹livedataæ˜¯å¦‚ä½•å°†æ•°æ®å˜åŒ–ä¸‹å‘åˆ°æ¯ä¸€ä¸ªè§‚å¯Ÿè€…çš„ // å¦‚æžœä¼ å€¼å°±æ˜¯é€šçŸ¥æŒ‡å®šçš„observerï¼Œä¼ Nullå°±æ˜¯é€šçŸ¥æ‰€æœ‰çš„observer void dispatchingValue(@Nullable ObserverWrapper initiator) { if (mDispatchingValue) { mDispatchInvalidated = true; return; } mDispatchingValue = true; do { mDispatchInvalidated = false; if (initiator != null) { considerNotify(initiator); initiator = null; } else { for (Iterator&lt;Map.Entry&lt;Observer&lt;? super T>, ObserverWrapper>> iterator = mObservers.iteratorWithAdditions(); iterator.hasNext(); ) { considerNotify(iterator.next().getValue()); if (mDispatchInvalidated) { break; } } } } while (mDispatchInvalidated); mDispatchingValue = false; } // è¿™é‡Œè·³è¿‡åˆ†æžSafeIterableMapï¼ŒFastSafeIterableMapï¼Œå…ˆæŠŠå®ƒä»¬å½“ä½œæ™®é€šçš„è¿­ä»£å™¨ï¼Œç€é‡çœ‹ä¸‹considerNotify private void considerNotify(ObserverWrapper observer) { if (!observer.mActive) { return; } // Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet. // we still first check observer.active to keep it as the entrance for events. So even if // the observer moved to an active state, if we've not received that event, we better not // notify for a more predictable notification order. if (!observer.shouldBeActive()) { observer.activeStateChanged(false); return; } if (observer.mLastVersion >= mVersion) { return; } observer.mLastVersion = mVersion; //noinspection unchecked observer.mObserver.onChanged((T) mData); } // å‰é¢è¯´äº†ï¼Œè¿™é‡Œçš„ObserverWrapperçš„å®žä¾‹æ˜¯LifecycleBoundObserver // é€šçŸ¥è§‚å¯Ÿè€…ä¹‹å‰é¦–å…ˆä¼šæ£€æŸ¥lifecycleOwnerçš„ç”Ÿå‘½å‘¨æœŸç„¶åŽå†æ£€æµ‹æ•°æ®çš„ç‰ˆæœ¬ï¼Œéƒ½ç¬¦åˆè¦æ±‚æ‰ä¼šé€šçŸ¥æ•°æ®æ›´æ–° åˆ°è¿™é‡Œï¼Œlivedataå†…éƒ¨æ•°æ®æµåŠ¨ä¸Žæ„ŸçŸ¥çš„è¿‡ç¨‹å·²å¤§ä½“åˆ†æžå®Œæˆäº†ï¼Œå®ƒå†…éƒ¨ç”¨SafeInterableMapä½œä¸ºè§‚å¯Ÿè€…çš„å®¹å™¨ï¼Œåœ¨æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™åˆ†å‘ç»™æ‰€æœ‰çš„è§‚å¯Ÿè€…ï¼Œåœ¨lifecycleOwnerç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜åŒ–æ—¶ä¹Ÿä¼šé€šè¿‡LifecycleBoundObserverçš„onStateChangedé€šçŸ¥æ•°æ®åˆ†å‘ã€‚ æ¢³ç†äº†ä¸€ä¸‹æµç¨‹å›¾ï¼š livedataå®žé™…åº”ç”¨livedataäº‹ä»¶æ€»çº¿ç®€å•å®žçŽ°import androidx.annotation.MainThread import androidx.lifecycle.LifecycleOwner import androidx.lifecycle.MutableLiveData import androidx.lifecycle.Observer import java.lang.Exception class LiveDataBus private constructor() { private val mLock = Object() companion object { val instance: LiveDataBus = LiveDataBus() } private val bus: HashMap&lt;String, BusLiveData&lt;Any>> by lazy { HashMap&lt;String, BusLiveData&lt;Any>>() } fun subscribe(owner: LifecycleOwner, observer: Observer&lt;Any>, event: String) { if (bus.containsKey(event)) { val wrapper = BusLiveDataWrapper(observer) val liveData = bus[event] if (liveData?.alreadySubmit == false) { wrapper.scrapPreEvent = true liveData.alreadySubmit = true } bus[event]?.observe(owner, wrapper) } } fun postEvent(event: String, addition: Any) { if (bus.containsKey(event)) { bus[event]?.postValue(addition) } else { synchronized(mLock) { bus[event] = BusLiveData(addition) } } } @MainThread fun setEvent(event: String, addition: Any) { if (bus.containsKey(event)) { bus[event]?.value = addition } else { bus[event] = BusLiveData(addition) } } inner class BusLiveData&lt;T>(t: T) : MutableLiveData&lt;T>(t) { var alreadySubmit: Boolean = false } inner class BusLiveDataWrapper&lt;T> constructor( private val observer: Observer&lt;T>, var scrapPreEvent: Boolean = false ) : Observer&lt;T> { override fun onChanged(t: T) { if (scrapPreEvent) { scrapPreEvent = true return } try { observer.onChanged(t) } catch (e: Exception) { // catch ClassCastException etc. e.printStackTrace() } } } } ç»“è¯­æœ€åŽï¼Œåšä¸‹æ€»ç»“ï¼Œlivedataçš„å¤§è‡´æµç¨‹å·²ç»åˆ†æžå®Œäº†ï¼Œä½†æ˜¯æ¯”è¾ƒé‡è¦çš„ç±»LifecycleRegistryåªæ˜¯ä¸€ç¬”å¸¦è¿‡äº†æ²¡æœ‰åšåˆ†æžï¼Œå®ƒæ˜¯å¦‚ä½•å°†ç”Ÿå‘½å‘¨æœŸå˜åŒ–äº‹ä»¶åˆ†å‘åˆ°è®¢é˜…è€…çš„å‘¢ï¼Ÿå¦å¤–è¿˜æœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„æ•°æ®ç»“æž„FastSafeIterableMapå’ŒSafeIterableMapï¼Œåœ¨è¿™é‡Œå…ˆè®°å½•ä¸€ä¸‹å•¦ï¼Œä»¥åŽå†å¡«ä¸Šå§ã€‚ðŸ–– å‚è€ƒ LiveData Overview by Android Developers ç”¨LiveDataBusæ›¿ä»£RxBusã€EventBusâ€”â€”Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ by ç¾Žå›¢æŠ€æœ¯å›¢é˜Ÿ æµ·äº®]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>jetpack</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Koltinå§”æ‰˜å±žæ€§]]></title>
    <url>%2F2019%2F10%2F24%2FKotlinDelegate%2F</url>
    <content type="text"><![CDATA[å§”æ‰˜æ¨¡å¼åœ¨Kotlinä¸­å§”æ‰˜æ¨¡å¼é€šè¿‡byå…³é”®å­—å®žçŽ° interface Base { fun print() } class Derived(b: Base): Base by b ä¸Šè¿°è¡¨è¾¾å¼è¡¨ç¤ºbå°†ä»£ç†DerivedåŽ»å®žçŽ°interface Baseçš„æ–¹æ³•ã€‚ å§”æ‰˜å±žæ€§å»¶è¿Ÿå±žæ€§(Lazy)Kotlinæ ‡å‡†åº“ä¸­æœ‰å¾ˆå¤šæœ‰ç”¨çš„å§”æ‰˜å±žæ€§(delegatesï¼Œä»£ç†å±žæ€§)ï¼Œåƒä½¿ç”¨lazyæ–¹æ³•åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œåªæœ‰åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™ä¼šè¢«åˆå§‹åŒ–ã€‚ lazyçš„é‡è½½æ–¹æ³• public actual fun &lt;T> lazy(initializer: () -> T): Lazy&lt;T> = SynchronizedLazyImpl(initializer) public actual fun &lt;T> lazy(lock: Any?, initializer: () -> T): Lazy&lt;T> = SynchronizedLazyImpl(initializer, lock) public actual fun &lt;T> lazy(mode: LazyThreadSafetyMode, initializer: () -> T): Lazy&lt;T> = when (mode) { LazyThreadSafetyMode.SYNCHRONIZED -> SynchronizedLazyImpl(initializer) LazyThreadSafetyMode.PUBLICATION -> SafePublicationLazyImpl(initializer) LazyThreadSafetyMode.NONE -> UnsafeLazyImpl(initializer) } ç”±ä¸Šå¯è§ï¼ŒLazyæŽ¥å£çš„å®žçŽ°ç±»æœ‰ä¸‰ç§SynchronizedLazyImplï¼ŒSafePublicationLazyImplï¼ŒUnsafeLazyImplï¼Œå‰ä¸¤è€…çº¿ç¨‹å®‰å…¨ï¼Œä½†æ˜¯å®žçŽ°æ–¹æ³•æœ‰æ‰€ä¸åŒï¼Œåˆ†åˆ«ä½¿ç”¨çº¿ç¨‹é”å’ŒåŽŸå­ç±»å®žçŽ° private class SynchronizedLazyImpl&lt;out T>(initializer: () -> T, lock: Any? = null) : Lazy&lt;T>, Serializable { private var initializer: (() -> T)? = initializer @Volatile private var _value: Any? = UNINITIALIZED_VALUE // final field is required to enable safe publication of constructed instance private val lock = lock ?: this override val value: T get() { val _v1 = _value if (_v1 !== UNINITIALIZED_VALUE) { @Suppress("UNCHECKED_CAST") return _v1 as T } return synchronized(lock) { val _v2 = _value if (_v2 !== UNINITIALIZED_VALUE) { @Suppress("UNCHECKED_CAST") (_v2 as T) } else { val typedValue = initializer!!() _value = typedValue initializer = null typedValue } } } override fun isInitialized(): Boolean = _value !== UNINITIALIZED_VALUE override fun toString(): String = if (isInitialized()) value.toString() else "Lazy value not initialized yet." private fun writeReplace(): Any = InitializedLazyImpl(value) } private class SafePublicationLazyImpl&lt;out T>(initializer: () -> T) : Lazy&lt;T>, Serializable { @Volatile private var initializer: (() -> T)? = initializer @Volatile private var _value: Any? = UNINITIALIZED_VALUE // this final field is required to enable safe publication of constructed instance private val final: Any = UNINITIALIZED_VALUE override val value: T get() { val value = _value if (value !== UNINITIALIZED_VALUE) { @Suppress("UNCHECKED_CAST") return value as T } val initializerValue = initializer // if we see null in initializer here, it means that the value is already set by another thread if (initializerValue != null) { val newValue = initializerValue() if (valueUpdater.compareAndSet(this, UNINITIALIZED_VALUE, newValue)) { initializer = null return newValue } } @Suppress("UNCHECKED_CAST") return _value as T } override fun isInitialized(): Boolean = _value !== UNINITIALIZED_VALUE override fun toString(): String = if (isInitialized()) value.toString() else "Lazy value not initialized yet." private fun writeReplace(): Any = InitializedLazyImpl(value) companion object { private val valueUpdater = java.util.concurrent.atomic.AtomicReferenceFieldUpdater.newUpdater( SafePublicationLazyImpl::class.java, Any::class.java, "_value" ) } } internal class UnsafeLazyImpl&lt;out T>(initializer: () -> T) : Lazy&lt;T>, Serializable { private var initializer: (() -> T)? = initializer private var _value: Any? = UNINITIALIZED_VALUE override val value: T get() { if (_value === UNINITIALIZED_VALUE) { _value = initializer!!() initializer = null } @Suppress("UNCHECKED_CAST") return _value as T } override fun isInitialized(): Boolean = _value !== UNINITIALIZED_VALUE override fun toString(): String = if (isInitialized()) value.toString() else "Lazy value not initialized yet." private fun writeReplace(): Any = InitializedLazyImpl(value) } è‡³äºŽ3è€…çš„åŒºåˆ«ï¼Œå®˜æ–¹æ–‡æ¡£ä¸Šå·²æœ‰è¯´æ˜Žï¼Œå¦‚æžœè¯¥å€¼åªåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è®¡ç®—ï¼Œå¹¶ä¸”æ‰€æœ‰çº¿ç¨‹ä¼šçœ‹åˆ°ç›¸åŒçš„å€¼å°±ä½¿ç”¨SynchronizedLazyImplï¼›å¦‚æžœè¯¥å€¼åœ¨å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æ‰§è¡Œï¼Œé‚£ä¹ˆä½¿ç”¨SafePublicationLazyImplï¼›å¦‚æžœåˆå§‹åŒ–å‘ç”Ÿä¸Žä½¿ç”¨åœ¨åŒä¸€ä¸ªçº¿ç¨‹å°±ä½¿ç”¨UnsafeLazyImplï¼Œå®ƒä¸ä¼šæœ‰ä»»ä½•çº¿ç¨‹å®‰å…¨çš„ä¿è¯å’Œå¼€é”€ã€‚ å¯è§‚å¯Ÿå±žæ€§(Observable)åœ¨kotlin.properties.Delegatesä¸­ï¼Œå¯ä»¥æ‰¾åˆ°ç›¸å…³æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯observableå’Œvetoableï¼Œå®ƒä»¬åœ¨è¢«è§‚å¯Ÿè€…çš„å€¼å‘ç”Ÿæ”¹å˜æ—¶ä¼šæ‰§è¡Œå›žè°ƒï¼Œå›žè°ƒæœ‰ä¸‰ä¸ªå€¼åˆ†åˆ«æ—¶è¢«è§‚å¯Ÿè€…çš„ç±»åž‹ï¼Œæ—§å€¼ä¸Žæ–°å€¼ï¼›ä¸¤è€…çš„åŒºåˆ«åœ¨äºŽï¼Œvetoableæ˜¯å¦ç»™è¢«è§‚å¯Ÿè€…èµ‹å€¼å–å†³ä¸Žå›žè°ƒå‡½æ•°çš„è¿”å›žå€¼ã€‚ var name: String by Delegates.observable("") { property, oldValue, newValue -> } var age: String by Delegates.vetoable("") { property, oldValue, newValue -> false } mapä»£ç†(map delegate)æš‚æ—¶æ²¡æœ‰ä½¿ç”¨è¿‡è¿™ç§ä»£ç†ã€‚ class User(val map: Map&lt;String, Any?>) { val name: String by map val age: Int by map } æŒ‰ç…§å®˜æ–¹æ–‡æ¡£çš„ä¾‹å­ï¼Œæ¥çœ‹ä¼ å…¥é”®å€¼å¯¹ï¼Œmapä»£ç†ä¼šæ ¹æ®é”®å€¼ç»™ç›¸å¯¹çš„å±žæ€§èµ‹å€¼ï¼Œç›¸å…³çš„å®žçŽ°æ–¹æ³•å¦‚ä¸‹ @kotlin.internal.InlineOnly public inline operator fun &lt;V, V1 : V> Map&lt;in String, @Exact V>.getValue(thisRef: Any?, property: KProperty&lt;*>): V1 = @Suppress("UNCHECKED_CAST") (getOrImplicitDefault(property.name) as V1) @kotlin.jvm.JvmName("getOrImplicitDefaultNullable") @PublishedApi internal fun &lt;K, V> Map&lt;K, V>.getOrImplicitDefault(key: K): V { if (this is MapWithDefault) return this.getOrImplicitDefault(key) return getOrElseNullable(key, { throw NoSuchElementException("Key $key is missing in the map.") }) } å¦‚æžœä¼ å…¥çš„mapæ²¡æœ‰å®žçŽ°MapWithDefaultæŽ¥å£ï¼Œkeyä¸å­˜åœ¨æ—¶ä¼šæŠ›å‡ºNoSuchElementExceptionå¼‚å¸¸ï¼Œå› æ­¤åˆå§‹åŒ–mapæ—¶ï¼Œéœ€è¦åšç±»ä¼¼å¦‚ä¸‹æ“ä½œï¼š emptyMap&lt;String, String>().withDefault { key -> "" } è¿™æ ·æ‰¾ä¸åˆ°ç›¸å¯¹åº”çš„key-valueæ—¶ï¼Œå°±ä¼šä½¿ç”¨é»˜è®¤å€¼äº†ï¼Œå®žçŽ°æ–¹æ³•å¦‚ä¸‹ï¼š internal inline fun &lt;K, V> Map&lt;K, V>.getOrElseNullable(key: K, defaultValue: () -> V): V { val value = get(key) if (value == null &amp;&amp; !containsKey(key)) { return defaultValue() } else { @Suppress("UNCHECKED_CAST") return value as V } } ä½¿ç”¨çš„åœºæ™¯æ²¡æœ‰é‡åˆ°è¿‡ï¼Œä½†æ˜¯æœ‰ç›¸å…³åšå®¢è¯´ï¼Œå¦‚æžœéœ€è¦é¢„å®šä¹‰keysçš„æ—¶å€™å¯ä»¥ä½¿ç”¨ï¼Œç›¸å…³åšæ–‡ä¼šè´´åœ¨ä¸‹é¢ ä½¿ç”¨èŒƒä¾‹Shared Preferencesprivate inline fun &lt;T> SharedPreferences.delegate( defaultValue: T, key: String?, crossinline getter: SharedPreferences.(String, T) -> T, crossinline setter: Editor.(String, T) -> Editor ): ReadWriteProperty&lt;Any, T> { return object: ReadWriteProperty&lt;Any, T> { override fun getValue(thisRef: Any, property: KProperty&lt;*>) = getter(key?:property.name, defaultValue) override fun setValue(thisRef: Any, property: KProperty&lt;*>, value: T) = edit().setter(key?:property.name, value).apply() } } æœ‰äº†å¦‚ä¸Šæ–¹æ³•æˆ‘ä»¬å°±å¯ä»¥æ”¹é€ SharedPreferencesäº†ï¼š // å­˜å‚¨Int fun SharedPreferences.int(def: Int=0, key: String?=null) = delegate(def, key, SharedPreferences::getInt, Editor::putInt) // å­˜å‚¨Long fun SharedPreferences.long(def: Long=0L, key: String?=null) = delegate(def, key, SharedPreferences::getLong), Editor::putLong) ä½¿ç”¨ var sthInt by prefs.int() init { sthInt = 1 } // sthIntçš„getterå’Œsetteréƒ½è¢«ä»£ç†äº†ï¼Œå–å€¼æ—¶å®žé™…ä¸Šè°ƒç”¨çš„æ˜¯SharedPreferences::getIntï¼Œè¢«èµ‹å€¼çš„åŒæ—¶ï¼Œä¹Ÿé€šè¿‡Editor::putIntå°†å€¼å­˜å…¥äº†SharedPreferencesä¸­ã€‚ æ›´å¤šçš„ä½¿ç”¨æ¡ˆä¾‹ä¼šé€ä¸€çš„æ·»åŠ çš„æ­¤ç¯‡ä¸­ã€‚ å‚è€ƒKotlin delegates in Android development - Part1 by Fabio Collini Kotlin å§”æ‰˜å±žæ€§]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>syntax</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[FragmentåŽŸç†æµ…æž]]></title>
    <url>%2F2019%2F09%2F29%2FFragment%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90%2F</url>
    <content type="text"><![CDATA[å‰è¨€Fragmentåœ¨æ—¥å¸¸å¼€å‘ä¸­éžå¸¸çš„å¸¸ç”¨ï¼Œä¸€ç‰ˆéƒ½æ˜¯é…åˆViewPageræˆ–FrameLayoutä½¿ç”¨ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸ç”¨æ‹…å¿ƒæ“ä½œå®ƒattachToActivityï¼Œå› ä¸ºFragmentManageréƒ½å¸®æˆ‘ä»¬å¤„ç†å¥½äº†ã€‚é‚£ä¹ˆFragmentæ˜¯å¦‚ä½•ç»‘å®šActivityçš„ç”Ÿå‘½å‘¨æœŸçš„å‘¢ï¼Ÿç³»ç»Ÿæ˜¯å¦‚ä½•å°†Fragmentæ·»åŠ åˆ°è§†å›¾å±‚çš„å‘¢ï¼ŸFragmentçš„å›žé€€æ ˆåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¸¦ç€è¿™äº›é—®é¢˜æˆ‘ä»¬å¼€å§‹æŽ¢ç´¢Fragmentçš„æºç å§ã€‚ åŸºæœ¬æ“ä½œé¦–å…ˆæ¥å›žé¡¾ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¦‚ä½•æ·»åŠ Fragmentçš„: val fm = supportFragmentManager val ts = fm.beginTransaction() ts.add(fragment) ts.commit() é¦–å…ˆå¼„æ¸…å‡ ä¸ªæ¦‚å¿µï¼š FragmentController ä¸»è¦ä½œç”¨æ˜¯ç»‘å®šActivityä¸ŽFragmentçš„ç”Ÿå‘½å‘¨æœŸï¼Œåœ¨FragmentActivityå¯ä»¥çœ‹åˆ°åœ¨æ¯ä¸ªç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼ŒFragmentControlleréƒ½æœ‰åšåˆ†å‘ï¼Œæœ€ç»ˆäº¤ç»™äº†FragmentManagerå¤„ç† FragmentManager Fragmentsçš„ç›´æŽ¥æ“ä½œè€…ï¼Œç®¡ç†Fragmentçš„å†…éƒ¨çŠ¶æ€ä»¥åŠæ·»åŠ \ç§»é™¤\éšè—\æ˜¾ç¤ºFragmentç­‰æ“ä½œ FragmentTransaction å¯¹Fragmentæ“ä½œçš„é›†åˆï¼Œå„é¡¹æ“ä½œä¼šå­˜å‚¨åœ¨Opsä¸­ï¼Œæœ€ç»ˆåœ¨FragmentManagerä¸­è¢«æ‰§è¡Œ tips: FragmentTransactionæœ¬èº«æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒåŒ…å«ç€ä¸€ä¸ªå†…éƒ¨ç±»Opï¼Œæ ¹æ®å…¶æž„é€ å‡½æ•°å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªç±»ç”¨äºŽè®°å½•Fragmentçš„æ“ä½œï¼Œå¹¶å°†è¿™ä¸€ç³»åˆ—æ“ä½œå­˜å‚¨åœ¨mOpsï¼Œå…¶ä¸­å››ä¸ªæŠ½è±¡æ–¹æ³•commit/commitAllowingStateLoss/commitNow/commitNowAllowingStateLosså°±æ˜¯æˆ‘ä»¬ç»å¸¸æ”¾åœ¨æœ€åŽæ‰§è¡Œçš„æ–¹æ³•äº†ã€‚ // fm.beginTransaction() @NonNull @Override public FragmentTransaction beginTransaction() { return new BackStackRecord(this); } BackStackRecordç»§æ‰¿äº†FragmentTransactionï¼Œå¯ä»¥çœ‹åˆ°åœ¨è¿™ä¸ªç±»ä¸­æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº†FragmentManagerçš„enqueueActionæ–¹æ³•ï¼Œå°†æ‰€æœ‰çš„æ“ä½œåŠ å…¥æ‰§è¡Œé˜Ÿåˆ—ä¸­ã€‚å¹¶å¯¹éœ€è¦è®°å½•Fragmentå›žé€€æ ˆçš„æ“ä½œåšå¦‚ä¸‹å¤„ç†ï¼š public int allocBackStackIndex(BackStackRecord bse) { synchronized (this) { if (mAvailBackStackIndices == null || mAvailBackStackIndices.size() &lt;= 0) { if (mBackStackIndices == null) { mBackStackIndices = new ArrayList&lt;BackStackRecord>(); } int index = mBackStackIndices.size(); if (DEBUG) Log.v(TAG, "Setting back stack index " + index + " to " + bse); // å°†å½“å‰æ“ä½œæ·»åŠ åˆ°æ•°ç»„ä¸­ mBackStackIndices.add(bse); return index; } else { // æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ä½ç½®è¿›è¡Œå­˜å‚¨å½“å‰æ“ä½œ int index = mAvailBackStackIndices.remove(mAvailBackStackIndices.size()-1); if (DEBUG) Log.v(TAG, "Adding back stack index " + index + " with " + bse); mBackStackIndices.set(index, bse); return index; } } } æœ€ç»ˆè°ƒç”¨äº†FragmentManagerçš„enqueueAction/execSingleActionï¼š public boolean execPendingActions() { // æ ¡éªŒå‡†å¤‡å·¥ä½œ ensureExecReady(true); boolean didSomething = false; // åˆå§‹åŒ–æ•°æ®æº while (generateOpsForPendingActions(mTmpRecords, mTmpIsPop)) { mExecutingActions = true; try { removeRedundantOperationsAndExecute(mTmpRecords, mTmpIsPop); } finally { // æ¸…é™¤æ‰§è¡Œç¨‹åº cleanupExec(); } didSomething = true; } updateOnBackPressedCallbackEnabled(); // ç­‰å¾…åŠ è½½å»¶è¿Ÿçš„Fragment doPendingDeferredStart(); burpActive(); return didSomething; } public void execSingleAction(OpGenerator action, boolean allowStateLoss) { if (allowStateLoss &amp;&amp; (mHost == null || mDestroyed)) { // This FragmentManager isn't attached, so drop the entire transaction. return; } ensureExecReady(allowStateLoss); if (action.generateOps(mTmpRecords, mTmpIsPop)) { mExecutingActions = true; try { removeRedundantOperationsAndExecute(mTmpRecords, mTmpIsPop); } finally { cleanupExec(); } } updateOnBackPressedCallbackEnabled(); doPendingDeferredStart(); burpActive(); } æ— è®ºæ˜¯æ‰§è¡ŒexecPendingActionsè¿˜æ˜¯execSingleActionï¼Œå…¶æ ¸å¿ƒæ–¹æ³•è¿˜æ˜¯removeRedundantOperationsAndExecuteï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥ç§»é™¤å†—ä½™çš„æ“ä½œï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æžœä¸¤ä¸ªäº‹åŠ¡ä¸€èµ·æ‰§è¡Œï¼Œä¸€ä¸ªç”¨äºŽæ·»åŠ FragmentAï¼Œä¸€ä¸ªç”¨äºŽå°†FragmentAæ›¿æ¢æˆFragmentBï¼Œå®žé™…ä¸Šåªæœ‰FragmentBä¼šè¢«æ·»åŠ ï¼Œæ— æ³•æ„Ÿåº”åˆ°FragmentAçš„åˆ›å»º/é”€æ¯ç”Ÿå‘½å‘¨æœŸã€‚è¿™ä¸ªå°±æ˜¯ç§»é™¤å†—ä½™æ“ä½œçš„å‰¯ä½œç”¨äº†ï¼ŒFragmentçš„çŠ¶æ€ä¸ä¼šå¦‚é¢„æƒ³é‚£æ ·å˜åŒ–ã€‚ç–‘é—®ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•åŽ»é™¤å†—ä½™æ“ä½œçš„å‘¢ï¼Ÿ // ç§»é™¤å†—ä½™çš„å›žé€€æ ˆæ“ä½œå†æ‰§è¡Œï¼Œéœ€è¦è®¾ç½®setReorderingAllowed(true) private void removeRedundantOperationsAndExecute(ArrayList&lt;BackStackRecord> records, ArrayList&lt;Boolean> isRecordPop) { // çœç•¥... final int numRecords = records.size(); int startIndex = 0; for (int recordNum = 0; recordNum &lt; numRecords; recordNum++) { final boolean canReorder = records.get(recordNum).mReorderingAllowed; // æ‰€æœ‰äº‹åŠ¡å¦‚æžœè®¾ç½®äº†setReorderingAllowed(true)åˆ™å…¨éƒ¨è·³è¿‡åœ¨æœ€åŽä¸€èµ·æ‰§è¡Œ if (!canReorder) { // execute all previous transactions // å¦‚æžœä¸­é—´æœ‰äº‹åŠ¡Aæ²¡æœ‰è®¾ç½®setReorderingAllowed(true)ï¼Œåˆ™ä»ŽstartIndexåˆ°äº‹åŠ¡Aä¼šè¢«ä¸€èµ·æ‰§è¡Œ if (startIndex != recordNum) { executeOpsTogether(records, isRecordPop, startIndex, recordNum); } // execute all pop operations that don't allow reordering together or one add operation // ä¸Šè¿°æ³¨é‡Šè¯´æ˜Žæ­¤å¤„æ‰§è¡Œæ‰€æœ‰ä¸å…è®¸ä¸€èµ·æŽ’åºçš„popæ“ä½œ // åœ¨BackStackRecordä¸­isRecordPopéƒ½ä¸ºfalseï¼Œåœ¨PopBackStackStateä¸­isRecordPopéƒ½ä¸ºtrueï¼Œè¿™ä¸¤ä¸ªç±»åˆ†åˆ«å¯¹åº”ç€å…¥æ ˆå’Œå‡ºæ ˆï¼Œä¸”ä»…å½“BackStackRecordè®¾ç½®äº†addToBackStackåŽæ‰ä¼šè¢«è®°å½• int reorderingEnd = recordNum + 1; if (isRecordPop.get(recordNum)) { while (reorderingEnd &lt; numRecords &amp;&amp; isRecordPop.get(reorderingEnd) &amp;&amp; !records.get(reorderingEnd).mReorderingAllowed) { reorderingEnd++; } } executeOpsTogether(records, isRecordPop, recordNum, reorderingEnd); startIndex = reorderingEnd; recordNum = reorderingEnd - 1; } } if (startIndex != numRecords) { executeOpsTogether(records, isRecordPop, startIndex, numRecords); } } æŽ¥ç€å¾€ä¸‹çœ‹executeOps private static void executeOps(ArrayList&lt;BackStackRecord> records, ArrayList&lt;Boolean> isRecordPop, int startIndex, int endIndex) { for (int i = startIndex; i &lt; endIndex; i++) { final BackStackRecord record = records.get(i); final boolean isPop = isRecordPop.get(i); if (isPop) { record.bumpBackStackNesting(-1); boolean moveToState = i == (endIndex - 1); // æ‰§è¡ŒPopBackStackState record.executePopOps(moveToState); } else { record.bumpBackStackNesting(1); // æ‰§è¡ŒBackStackRecord record.executeOps(); } } } ç„¶åŽæ˜¯BackStackRecordçš„executeOpsï¼Œæœ€ç»ˆè¿™äº›opsç”±FragmentManagerå¤„ç†ï¼Œå°†Fragmentæ·»åŠ è‡³mAddedæˆ–è€…ä»ŽmAddedä¸­ç§»é™¤ï¼Œå¹¶å¯¹Fragmentçš„å†…éƒ¨çŠ¶æ€è¿›è¡Œä¿®æ”¹ã€‚ æœ€åŽä¹Ÿæ˜¯æœ€é‡è¦çš„æ–¹æ³•moveToStateï¼Œå®ƒä¸»è¦è´Ÿè´£ä¿®æ”¹Fragmentçš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼Œåœ¨è¿™æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Fragmentæ˜¯å¦‚ä½•è¢«æ·»åŠ è‡³å®¹å™¨ä¸­çš„ï¼Œåœ¨æ­¤Fragmentä¸­å†…éƒ¨çŠ¶æ€é€šè¿‡FragmentMangeræ›´æ–°ã€‚ case Fragment.CREATED: //çœç•¥... f.mContainer = container; f.performCreateView(f.performGetLayoutInflater(f.mSavedFragmentState), container, f.mSavedFragmentState); if (f.mView != null) { f.mInnerView = f.mView; f.mView.setSaveFromParentEnabled(false); if (container != null) { // å°†fragmentçš„è§†å›¾æ·»åŠ åˆ°å®¿ä¸»çš„å®¹å™¨ä¸­ container.addView(f.mView); } if (f.mHidden) { f.mView.setVisibility(View.GONE); } // çœç•¥... } else { f.mInnerView = null; } // çœç•¥... è‡³æ­¤ï¼Œæ–‡ç« å¼€å§‹çš„ç–‘é—®å·®ä¸å¤šéƒ½è§£å†³äº†ï¼Œæœ€åŽå†æ¢³ç†ä¸€ä¸‹Fragmentåˆå§‹åŒ–æµç¨‹ã€‚æµç¨‹å›¾å¤§ä½“å¦‚ä¸‹ï¼š ç»“è¯­Fragmentçš„é€»è¾‘å¤æ‚ï¼Œå¦‚æžœä»…ä»…æ˜¯é è¯»æºç ï¼Œæ˜¯æ— æ³•ç†æ¸…å…¶å¤æ‚çš„é€»è¾‘å…³ç³»çš„ã€‚æ­¤æ–‡çš„ç›®çš„åªæ˜¯å¯¹Fragmentåšä¸€æ¬¡ç®€å•çš„æŽ¢ç´¢ï¼Œå¼„æ¸…æ¥šå®ƒæ˜¯å¦‚ä½•è¢«æ·»åŠ åˆ°è§†å›¾çš„ï¼Œå¦‚ä½•åŽ»æ„ŸçŸ¥Activityçš„ç”Ÿå‘½å‘¨æœŸçš„ï¼Œè‡³äºŽå®ƒçš„é«˜çº§ç”¨æ³•ä»¥åŠä½¿ç”¨æ³¨æ„äº‹é¡¹å°†ä¼šå‘å¸ƒåœ¨å…¶åŽçš„æ–‡ç« ã€‚]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>framework</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Androidå¤šæ¸ é“æ‰“åŒ…åŠåŠ å›ºæ–¹æ¡ˆ]]></title>
    <url>%2F2019%2F09%2F25%2FAndroid%E5%A4%9A%E6%B8%A0%E9%81%93%E6%89%93%E5%8C%85%E5%8F%8A%E5%8A%A0%E5%9B%BA%E6%96%B9%E6%A1%88%2F</url>
    <content type="text"><![CDATA[å‰è¨€Androidå¤šæ¸ é“æ‰“åŒ…å·²ç»æ˜¯è€ç”Ÿå¸¸è°ˆçš„é—®é¢˜äº†ï¼Œå„ä¸ªå¤§åŽ‚ä¹Ÿå…ˆåŽå¼€æºäº†è‡ªå·±çš„æ‰“åŒ…æ–¹æ¡ˆï¼Œä¸ºæˆ‘ä»¬å¼€å‘è€…å¸¦æ¥ä¸å°‘ä¾¿æ·ã€‚ä»Šå¤©æˆ‘å°±æ¥è°ˆè°ˆç¾Žå›¢çš„Walleï¼Œæˆ‘åœ¨é¡¹ç›®ä¸­ä¹Ÿæ­£æ˜¯ç”¨åˆ°äº†å®ƒï¼Œä¹Ÿç®—åšä¸ªæ€»ç»“å’Œå¤‡å¿˜å§ã€‚æœ¬ç¯‡ä¸­ä¼šæåŠWalleçš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ä»¥åŠå¦‚ä½•åœ¨é¡¹ç›®ä¸­é…ç½®åŠ å›ºä½¿ç”¨ï¼Œå½“ç„¶ï¼Œæœ€åŽä¹Ÿç¨å¾®ä¼šä»Žæºç çš„è§’åº¦åŽ»åˆ†æžä¸€ä¸‹è¿™ä¸ªæ–¹æ¡ˆçš„åŽŸç†ã€‚é‚£ä¹ˆï¼ŒçŽ°åœ¨å¼€å§‹å§ã€‚ å¦‚ä½•ä½¿ç”¨å‚è€ƒWalleé¡¹ç›®Githubé¦–é¡µï¼Œæ“ä½œå¦‚ä¸‹ï¼šåœ¨å·¥ç¨‹ç›®å½•å¼•å…¥ buildscript { dependencies { classpath 'com.meituan.android.walle:plugin:1.1.6' } } åœ¨appç›®å½•ä¸‹å¼•å…¥ apply plugin: 'walle' dependencies { // ç”¨äºŽè¯»å–æ¸ é“å· compile 'com.meituan.android.walle:library:1.1.6' } é…ç½®ä¿¡æ¯å‘¢ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹è¯´æ˜Žï¼Œæˆ‘è¿™å°±ç®€å•è®°å½•ä¸‹(copy)äº† walle { // æŒ‡å®šæ¸ é“åŒ…çš„è¾“å‡ºè·¯å¾„ apkOutputFolder = new File("${project.buildDir}/outputs/channels"); // å®šåˆ¶æ¸ é“åŒ…çš„APKçš„æ–‡ä»¶åç§° apkFileNameFormat = '${appName}-${packageName}-${channel}-${buildType}-v${versionName}-${versionCode}-${buildTime}.apk'; // æ¸ é“é…ç½®æ–‡ä»¶ ä¸€ä¸ªæ¸ é“å ä¸€è¡Œ channelFile = new File("${project.getProjectDir()}/channel") } ä¸è¦å¿˜è®°èŽ·å–æ¸ é“ä¿¡æ¯ val channel = WalleChannelReader.getChannel(context) UMConfigure.init(this, UMENG_APP_KEY, channel, UMConfigure.DEVICE_TYPE_PHONE, "") æŽ¥ä¸‹æ¥åªéœ€è¦åœ¨gradleä»»åŠ¡æ‰§è¡ŒchannelReleaseæˆ–æ˜¯æ‰§è¡Œ gradlew clean assembleReleaseChannels æ¸ é“åŒ…å°±èƒ½ç”Ÿæˆåœ¨ä½ æŒ‡å®šçš„ç›®å½•ä¸‹é¢äº†ã€‚ ä½†æ˜¯è¿™æ ·æ“ä½œå®Œä¹‹åŽå°±æ²¡é—®é¢˜äº†å—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯ã€‚é€šå¸¸æˆ‘ä»¬å‘å¸ƒè‡ªå·±çš„åº”ç”¨ä¹‹å‰ï¼Œè¿˜éœ€è¦è¿›è¡Œåº”ç”¨åŠ å›º(360æˆ–æ˜¯ä¹å›ºï¼Œæœ¬æ–‡ç”¨çš„æ˜¯ä¹å›º)ï¼ŒåŠ å›ºåŽä¼šæ¸…é™¤apkçš„ç­¾åå’Œæ¸ é“ä¿¡æ¯ï¼Œéœ€è¦é‡æ–°ç­¾åç„¶åŽå†™å…¥æ¸ é“ä¿¡æ¯ã€‚å› æ­¤ï¼Œæ‰“æ¸ é“å˜æˆäº†å¦‚ä¸‹æµç¨‹ï¼š è¦æ»¡è¶³ä¸Šé¢çš„æ“ä½œï¼Œé¡¹ç›®ä¸­walleçš„é…ç½®æ˜¾ç„¶å°±ä¸å¤ªåˆé€‚äº†ï¼Œå¹¸äºwalleå›¢é˜Ÿä¹Ÿæœ‰æä¾›å‘½ä»¤è¡Œå·¥å…·walle-cliä¾›æˆ‘ä»¬è‡ªè¡Œæ‰“åŒ…ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘è‡ªå·±å†™äº†ä¸ªç®€å•çš„è„šæœ¬ï¼Œè‡ªåŠ¨ä¸Šä¼ åˆ°ä¹å›ºåŠ å›ºç„¶åŽè¿›è¡Œç­¾åå†™å…¥æ¸ é“ä¿¡æ¯ï¼Œå…·ä½“å¯ä»¥å‚è€ƒä¸€ä¸‹autoReinforceçš„é¡¹ç›®è¯´æ˜Žã€‚ æºç åˆ†æžæœ‰å‡ ä¸ªé—®é¢˜æƒ³é—®ä¸‹å¤§å®¶ã€‚ æ¸ é“ä¿¡æ¯å†™åœ¨å“ªé‡Œäº†å‘¢ï¼Ÿä¸ºä»€ä¹ˆå†™åœ¨è¿™ä¸ªä½ç½®å‘¢ï¼Ÿ æ¸ é“ä¿¡æ¯æ˜¯å¦‚ä½•è¿›è¡Œè¯»å†™æ“ä½œçš„å‘¢ï¼Ÿ ç¬¬ä¸€ä¸ªé—®é¢˜å¾ˆç®€å•å•¦ï¼Œæ–‡æ¡£ä¸Šä¹Ÿè¯´äº†å†™åœ¨äº†Apkä¸­çš„APK Signature BlockåŒºå—ï¼Œå¦‚ä¸‹å›¾ï¼Œä¹‹æ‰€ä»¥å†™åœ¨è¿™ä¸ªä½ç½®æ˜¯å› ä¸ºv2ä¸ä¼šå¯¹è¯¥åŒºåŸŸè¿›è¡Œæ ¡éªŒã€‚ åœ¨payload_readerå¯ä»¥æ‰¾åˆ°å†™å…¥æ¸ é“çš„é€»è¾‘ï¼Œåœ¨è®²è¿°é€»è¾‘ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦äº†è§£ä¸€ä¸‹EOCD(End of Centtal Directory)çš„ç»“æž„ï¼š offset Bytes Description 0 4 End of central directory signature = 0x06054b50 4 2 Number of this disk 6 2 Disk where central directory starts 8 2 Number of central directory records on this disk 10 2 Total number of central directory records 12 4 Size of central directory (bytes) 16 4 Offset of start of central directory, relative to start of archive 20 2 Comment length (n) 22 n Comment ç”±äºŽæ¸ é“ä¿¡æ¯æ˜¯å†™åœ¨APK Signature Blockï¼Œå› æ­¤åªè¦æ‰¾åˆ°Center Directoryçš„ä½ç½®ï¼Œé‚£ä¹ˆå¾€å‰å°±èƒ½æ‰¾åˆ°Apk Signing Blockçš„ä½ç½®ã€‚åœ¨Walleä¸­ï¼Œé€šè¿‡å¾ªçŽ¯æ‰¾åˆ°é­”æ•°0x06054b50(å‡è®¾Commentä¸ºç©ºï¼Œé€šè¿‡å¢žåŠ Commentçš„é•¿åº¦ï¼Œç¡®å®šEOCD blockçš„ä½ç½®)ï¼Œä»Žè€Œç¡®å®šcommentçš„é•¿åº¦ï¼Œå†å°†é•¿åº¦ä¸ŽComment lengthå¯¹æ¯”ï¼Œåªè¦èƒ½ç¡®è®¤Commentçš„é•¿åº¦ï¼Œå°±èƒ½ç¡®è®¤APK Signature Blockçš„ä½ç½®äº†ã€‚APK Signature Blockç»“æž„å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š offset Bytes Description @+0 8 blockçš„é•¿åº¦(å½“å‰é•¿åº¦ä¸è®¡ç®—åœ¨å†…) @+8 n ID-valueå€¼ @-24 8 blockçš„é•¿åº¦ @-16 16 é­”æ•°â€APK Sig Block 42â€ walleæ¸ é“ä¿¡æ¯å°±æ˜¯å†™åœ¨ID-valueä¸­ï¼Œåœ¨ä¸Šä¸€æ­¥ä¸­å·²ç»æ‹¿åˆ°Center Directoryçš„offsetï¼Œå†å‘å‰24bytesï¼Œå–8bytesï¼Œå°±èƒ½æ‹¿åˆ°APK Signature Blockçš„é•¿åº¦äº†ï¼Œæ³¨æ„è¿™ä¸ªé•¿åº¦æ˜¯ä¸åŒ…æ‹¬å‰é¢8ä¸ªbytesçš„ï¼Œåœ¨walleä¸­å‘å‰å¤šåç§»äº†8ä¸ªbytesï¼Œå–é¦–å°¾blocké•¿åº¦å¯¹æ¯”è¿›è¡Œæ ¡éªŒï¼Œä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š // Find the APK Signing Block. The block immediately precedes the Central Directory. if (centralDirOffset &lt; APK_SIG_BLOCK_MIN_SIZE) { throw new SignatureNotFoundException( "APK too small for APK Signing Block. ZIP Central Directory offset: " + centralDirOffset); } // åŽé¢16byteså°±æ˜¯é­”æ•°å•¦ åŠ ä¸Šå‰é¢8bytesçš„blacké•¿åº¦ä¿¡æ¯ï¼Œ24bytes // * 16 bytes: magic fileChannel.position(centralDirOffset - 24); final ByteBuffer footer = ByteBuffer.allocate(24); fileChannel.read(footer); footer.order(ByteOrder.LITTLE_ENDIAN); // è¿™é‡Œä¸æ˜¯å¾ˆæ¸…æ¥šä¸ºä»€ä¹ˆè¦å°†é­”æ•°æ‹†å¼€æ¥å¯¹æ¯”ï¼Ÿ if ((footer.getLong(8) != APK_SIG_BLOCK_MAGIC_LO) || (footer.getLong(16) != APK_SIG_BLOCK_MAGIC_HI)) { throw new SignatureNotFoundException( "No APK Signing Block before ZIP Central Directory"); } // å°¾éƒ¨è®°å½•çš„blocké•¿åº¦ final long apkSigBlockSizeInFooter = footer.getLong(0); if ((apkSigBlockSizeInFooter &lt; footer.capacity()) || (apkSigBlockSizeInFooter > Integer.MAX_VALUE - 8)) { throw new SignatureNotFoundException( "APK Signing Block size out of range: " + apkSigBlockSizeInFooter); } // å°†æ€»é•¿åº¦ä¸Žå¤´éƒ¨è®°å½•çš„8bytesé•¿åº¦ç›¸åŠ  final int totalSize = (int) (apkSigBlockSizeInFooter + 8); final long apkSigBlockOffset = centralDirOffset - totalSize; if (apkSigBlockOffset &lt; 0) { throw new SignatureNotFoundException( "APK Signing Block offset out of range: " + apkSigBlockOffset); } fileChannel.position(apkSigBlockOffset); final ByteBuffer apkSigBlock = ByteBuffer.allocate(totalSize); fileChannel.read(apkSigBlock); apkSigBlock.order(ByteOrder.LITTLE_ENDIAN); // å¤´éƒ¨å’Œå°¾éƒ¨çš„é•¿åº¦æœæ¯”æ ¡éªŒ final long apkSigBlockSizeInHeader = apkSigBlock.getLong(0); if (apkSigBlockSizeInHeader != apkSigBlockSizeInFooter) { throw new SignatureNotFoundException( "APK Signing Block sizes in header and footer do not match: " + apkSigBlockSizeInHeader + " vs " + apkSigBlockSizeInFooter); } // æ‹¿åˆ°APK Signing Blockäº† å†æ¥çœ‹çœ‹ID-valueåŒºåŸŸç»“æž„ Bytes Description 8 åºåˆ—é•¿åº¦n(ä¸åŒ…æ‹¬å…¶æœ¬èº«) 4 åºåˆ—id n-4 å†…å®¹ äº†è§£äº†ID-valueåŒºåŸŸç»“æž„é‚£ä¹ˆå†è´´ä¸€ä¸‹èŽ·å–custom ID-valueçš„ä»£ç  // APK Sig Block ä¸­çš„ID-valueåŒºåŸŸ final ByteBuffer pairs = sliceFromTo(apkSigningBlock, 8, apkSigningBlock.capacity() - 24); final Map&lt;Integer, ByteBuffer> idValues = new LinkedHashMap&lt;Integer, ByteBuffer>(); // keep order int entryCount = 0; while (pairs.hasRemaining()) { entryCount++; if (pairs.remaining() &lt; 8) { throw new SignatureNotFoundException( "Insufficient data to read size of APK Signing Block entry #" + entryCount); } // èŽ·å–æ€»é•¿åº¦ 8bytes final long lenLong = pairs.getLong(); if ((lenLong &lt; 4) || (lenLong > Integer.MAX_VALUE)) { throw new SignatureNotFoundException( "APK Signing Block entry #" + entryCount + " size out of range: " + lenLong); } final int len = (int) lenLong; // idå¼€å§‹çš„ä½ç½® final int nextEntryPos = pairs.position() + len; if (len > pairs.remaining()) { throw new SignatureNotFoundException( "APK Signing Block entry #" + entryCount + " size out of range: " + len + ", available: " + pairs.remaining()); } // èŽ·å–id 4bytes final int id = pairs.getInt(); idValues.put(id, getByteBuffer(pairs, len - 4)); pairs.position(nextEntryPos); } è‡³æ­¤å°±åˆ†æžå®Œäº†å¦‚ä½•åœ¨APKä¸­åŽ»è¯»å–æ’å…¥çš„æ¸ é“ä¿¡æ¯ï¼Œé¡ºå¸¦äº†è§£äº†ä¸€ä¸‹APKåŒ…çš„ç»“æž„ã€‚æœ€åŽè¿‡ä¸€ä¸‹å¦‚ä½•å†™å…¥æ¸ é“ä¿¡æ¯çš„å§ï¼Œæµç¨‹å¦‚ä¸‹ï¼š é€šè¿‡commentLength\centralDirStartOffset\apkSigningBlockAndOffsetæ‰¾åˆ°IdValuesçš„ä½ç½® åœ¨IdValues blockä¸­æ‰¾åˆ°V2ç­¾åçš„ä½ç½®ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»ç­¾å åˆ¤æ–­æ˜¯å¦ä½¿ç”¨V3ç­¾åï¼Œå¦‚æžœæœ‰å°†é•¿åº¦è¡¥æˆ4096çš„å€æ•°(V3ç­¾åä¼šæ ¡éªŒ) å†™å…¥æ¸ é“ ç»“è¯­ä»Žå¤šæ¸ é“æ‰“åŒ…ï¼Œå¼•ç”³å‡ºäº†Apkçš„ç­¾åV2ç­¾åé€»è¾‘(V1ç±»ä¼¼ï¼Œä½†æ˜¯æ˜¯æ”¾åœ¨EOCDçš„Commentä¸­)ï¼ŒApk(Zip)åŒ…çš„ç»“æž„ç­‰é—®é¢˜ã€‚è¿™é‡Œåªæ˜¯ç®€å•çš„åšä¸‹è‡ªæˆ‘æ€»ç»“ï¼Œå¦‚æœ‰ç–‘é—®æ¬¢è¿Žç•™è¨€ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©åŽ»çœ‹çœ‹å®˜æ–¹çš„æ–‡æ¡£å’Œå¤§ç¥žä»¬çš„åšå®¢ã€‚ å‚è€ƒ å¸¦ä½ äº†è§£è…¾è®¯å¼€æºçš„å¤šæ¸ é“æ‰“åŒ…æŠ€æœ¯ VasDollyæºç è§£æž by é¸¿æ´‹ APKæ–‡ä»¶ç»“æž„è¯¦è§£ Meituan-Dianping/walle Tencent/VasDolly]]></content>
      <categories>
        <category>tools</category>
      </categories>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[vpsæ­å»ºssræœåŠ¡å™¨]]></title>
    <url>%2F2019%2F09%2F21%2Fvps%E6%90%AD%E5%BB%BAssr%E6%9C%8D%E5%8A%A1%E5%99%A8%2F</url>
    <content type="text"><![CDATA[å‰è¨€å‘çŽ°æœ€è¿‘ä¸€äº›æ­å»ºssræœåŠ¡å™¨çš„æ•™ç¨‹éƒ½è¢«è¿«ä¸‹çº¿äº†ï¼Œå¿ƒé‡Œæ…Œçš„ä¸€åŒ¹ï¼ŒåŽŸå…ˆéƒ½æ˜¯å‚ç…§æ•™ç¨‹æ¥æ­å»ºçš„ï¼Œæ²¡æœ‰æ•™ç¨‹æˆ‘å¯æ€Žä¹ˆåŠžï¼Œèµ¶ç´§å¤‡ä»½ä¸€æ³¢ã€‚ vpsæœåŠ¡å™¨é€‰æ‹©åŽŸå…ˆä¸€ç›´ç”¨æ¬ç“¦å·¥ï¼Œå› ä¸ºä¾¿å®œå•Šï¼Œç”¨äº†ä¸€å¹´å¤šipè¢«å°äº†ï¼ŒèŠ±äº†å°†è¿‘10ç¾Žå…ƒé‡ç½®ï¼Œä¸€å¤©ä¸åˆ°åˆç»™æˆ‘å°äº†ï¼Œé‚æ¢æˆvultr(1RMBä¸€å¤©)ï¼Œè¿™ä¸ªæ¯”æ¬ç“¦å·¥(9.99ç¾Žå…ƒä¸€å¹´)è´µä¸Šä¸å°‘ï¼Œä½†æ˜¯å¥½åœ¨èƒ½éšæ—¶å…è´¹æ¢ipï¼Œè¿™ä¸ªipè¢«å°äº†ï¼Œæˆ‘å†æ¢ä¸€ä¸ªã€‚ä¸‹é¢çš„æœåŠ¡å•†æˆ‘å°±æ²¡ç”¨è¿‡äº†ï¼Œå…ˆè®°å½•ç€ï¼Œä¸‡ä¸€å“ªä¸€å¤©vulträ¹Ÿä¸å¥½ç”¨äº†å‘¢ã€‚ å•†å®¶ ä»·æ ¼(æœ€ä½Žé…) https://digital-vm.com $4/MONTHLY $41/YEARLY https://www.onevps.com $4/MONTHLY www.fastcomet.com $2.95/MONTHLY https://www.hostkvm.com $9.5/MONTHLY https://www.locvps.com 68RMB/MONTHLY https://zheye.io 88RMB/MONTHLY https://www.jwdns.com 88RMB/MONTHLY https://hxkvm.com 65RMB/MONTHLY https://www.gke.cc 65RMB/MONTHLY www.aoyouhost.com 48RMB/MONTHLY æ³¨1ï¼šè¿™é‡Œåªè¿›è¡Œä»·æ ¼å¯¹æ¯”ï¼Œè¯¦ç»†é…ç½®è¿˜éœ€è‡ªè¡Œä»”ç»†æŸ¥çœ‹æ³¨2ï¼šå¦‚æžœé€‰æ‹©äº†vultrï¼Œä¸€å®šè¦å…ˆæµ‹è¯•ä¸€ä¸‹æœåŠ¡å™¨ipæ˜¯å¦è¢«å¢™äº†ï¼Œç„¶åŽå†è¿›è¡Œä¸‹é¢çš„æ“ä½œï¼Œå¦‚æžœè¢«å¢™äº†ï¼Œè¯·æ¢ä¸€å°æœåŠ¡å™¨å†è¯•ï¼ éƒ¨ç½²(éžæ–°æ‰‹å‘) å®‰è£…è„šæœ¬ wget --no-check-certificate https://freed.ga/github/shadowsocksR.sh; bash shadowsocksR.sh æ³¨ï¼šæ ¹æ®è„šæœ¬æç¤ºé€‰æ‹©å¯†ç ï¼Œç«¯å£å·ç­‰ï¼Œæœ€åŽè¯·å°å¿ƒä¿å­˜é…ç½®ä¿¡æ¯ å®‰è£…é”é€Ÿ ç•™æ„çœ‹è‡ªå·±æœåŠ¡å™¨æ‰€å®‰è£…çš„ç³»ç»Ÿï¼Œå¦‚æžœæ˜¯centos6*64ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š wget --no-check-certificate -O appex.sh https://raw.githubusercontent.com/hombo125/doubi/master/appex.sh && bash appex.sh install '2.6.32-642.el6.x86_64' å¦‚æžœæ˜¯centos7*64åˆ™éœ€å…ˆæ›´æ¢ç³»ç»Ÿå†…æ ¸ wget --no-check-certificate -O rskernel.sh https://raw.githubusercontent.com/hombo125/doubi/master/rskernel.sh && bash rskernel.sh ç„¶åŽå†å®‰è£…é”é€Ÿ yum install net-tools -y && wget --no-check-certificate -O appex.sh https://raw.githubusercontent.com/0oVicero0/serverSpeeder_Install/master/appex.sh && bash appex.sh install é…ç½®ä¿¡æ¯å¦‚ä¸‹å›¾æ‰€ç¤º(å…¶å®žä¸æ˜¯å¾ˆæ˜Žç™½ç¬¬ä¸€é¡¹ä¸ºå•¥é€‰n) ç»“æŸè¯­åˆ°è¿™é‡Œï¼Œæ‰€æœ‰æµç¨‹éƒ½å·²ç»èµ°å®Œäº†ï¼Œæœ€åŽæé†’å¤§å®¶æ‰€æœ‰çš„é…ç½®ä¿¡æ¯ä¸€å®šè¦å¦¥å–„ä¿å­˜å“Ÿã€‚ å‚è€ƒ ç”¨VPSæ­å»ºSSRæœåŠ¡å™¨æ•™ç¨‹(å†™çš„çœŸçš„å¾ˆè¯¦ç»†ï¼Œæ–°æ‰‹å°ä¼™ä¼´å¯ä»¥è¿‡åŽ»å­¦ä¹ ä¸€ä¸‹)]]></content>
      <categories>
        <category>ssr</category>
      </categories>
      <tags>
        <tag>å…¶ä»–</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Kotlinè¯­æ³•ç³– Part3]]></title>
    <url>%2F2019%2F04%2F05%2FKotlin%E8%AF%AD%E6%B3%95%E7%B3%96Part3%2F</url>
    <content type="text"><![CDATA[å‰è¨€åœ¨å‰é¢çš„ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°äº†ï¼š sealed when() with() inline function and reified type åœ¨è¿™ç« ä¸­ï¼Œæˆ‘ä¼šç»™å¤§å®¶åˆ†äº«æˆ‘æ˜¯å¦‚ä½•ä½¿ç”¨Kotlinå§”æ‰˜æœºåˆ¶çš„ã€‚ Kotlinçš„å§”æ‰˜æœºåˆ¶Kotlinæœ‰ä¸€ä¸ªå†…ç½®çš„å§”æ‰˜æ¨¡å¼ã€‚åœ¨ä¸€äº›ä¹¦ä¸­ä¹ŸæåŠå§”æ‰˜æ¨¡å¼æ˜¯å®žçŽ°ç»§æ‰¿çš„ä¸€ä¸ªå¾ˆå¥½çš„æ›¿ä»£æ–¹å¼ï¼Œåœ¨Kotlinä½¿ç”¨å®ƒè¿›è¡Œèšåˆéžå¸¸å®¹æ˜“ï¼š interface Navigable { val onNavigationClick: (()->Unit)? } interface Searchable { val searchText:String } class Component(navigation: Navigable, searchable: Searchable): Navigable by navigable, Searchabe by searchable ä½¿ç”¨byå…³é”®å­—ï¼Œå³å¯å§”æ‰˜navigationã€searchableçš„æ‰€æœ‰è¡Œä¸ºã€‚æ¯”èµ·Javaï¼ŒKotlinå‡å°‘äº†å¤§é‡çš„æ¨¡æ¿ä»£ç ã€‚å¦‚æžœä½ æŠŠinterfaceæ ‡è®°ä¸ºinternalï¼Œä½ ä¼šå‘çŽ°ç¼–è¯‘ä¸èƒ½é€šè¿‡ â€˜publicâ€™ function exposes its â€˜internalâ€™ parameter type xxx Kotlinç¼–è¯‘å™¨ä¸å…è®¸æš´éœ²æ¨¡å—çš„å†…éƒ¨ç»„ä»¶ï¼Œå¦‚æžœæƒ³åœ¨ä¸æš´éœ²Navigableï¼ŒSearchableçš„å‰æä¸‹è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ åªéœ€è¦åšï¼š ç§»é™¤æž„é€ å™¨ ä½¿ç”¨ç»„åˆä»£æ›¿èšåˆ å®šä¹‰åŒ…å«Navigableå’ŒSearchableæ–¹æ³•åçš„ComponentInterface interface ComponentInterface { val onNavigationClick: (()->Unit)? var searchText: String } class Component: ComponentInterface { private val navigable: Navigable = NavigableImpl() private val searchable: Searchable = SearchableImpl() override val onNavigationClick: (()->Unit)? get() = navigable.onNavigationClick override var searchText: String = "" get() = searchable.searchText set(value) { field = value searchable.searchText = value } } ç»è¿‡æ”¹é€ åŽï¼Œä½ å‘çŽ°ä»£ç ä»Žé›¶æ¨¡æ¿çš„èšåˆå˜æˆäº†çœ‹ä¸ŠåŽ»å¾ˆè®¨åŽŒçš„ç»„åˆæ–¹å¼ã€‚ä½†æ˜¯å…ˆåˆ«å“­ï¼ŒKotlinæ€»èƒ½ç»™ä½ å¸¦æ¥æ„‰æ‚¦çš„ç¼–ç ä½“éªŒã€‚Kotlinä¸ä»…æ”¯æŒä½¿ç”¨byå…³é”®å­—å¯¹æŒ‡å®šå¯¹è±¡è¿›è¡Œæ–¹æ³•å§”æ´¾ï¼Œè¿˜å…·æœ‰å§”æ‰˜å±žæ€§çš„æœºåˆ¶ã€‚ä½ å¯èƒ½å·²ç»åœ¨ä½¿ç”¨lazyå…³é”®å­—åˆå§‹åŒ–å¯¹è±¡æ—¶æŽ¥è§¦åˆ°äº†å®ƒçš„è¿™ä¸€æœºåˆ¶äº†ã€‚ private val lazyProperty by lazy { "" } æ€Žä¹ˆä»Žä½¿ç”¨lazy()ä¸Šæ¥æ”¹é€ ä¸Šé¢ç»„åˆçš„ä»£ç å‘¢ï¼Œè¯·çœ‹ä»£ç ï¼š class ReferencedProperty&lt;T>(private val get: () -> T, private val set: (T) -> Unit = {}) { operator fun getValue(thisRef: Any?, property: KProperty&lt;*>): T = get() operator fun setValue(thisRef: Any?, property: KProperty&lt;*>, value: T) = set(value) } fun &lt;T> ref(property: KMutableProperty0&lt;T>) = ReferencedProperty(property::get, property::set) fun &lt;T> ref(property: KProperty0&lt;T>) = ReferencedProperty(property::get) ReferencedPropertyç”¨ä¸¤ä¸ªæ–¹æ³•ä½œä¸ºå‚æ•°ï¼Œå¹¶å®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°ï¼š getå‡½æ•°è¿”å›žæ³›åž‹T setå‡½æ•°ä»¥Tä½œä¸ºå‚æ•° getValue()è°ƒç”¨get() setValue()è°ƒç”¨set() æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯ä½ éœ€è¦çŸ¥é“æ“ä½œç¬¦ç”¨åˆ°äº†å±žæ€§ä»£ç†æœºåˆ¶ã€‚åœ¨ReferencedPropertyç±»ä¸‹ï¼Œä½ ä¼šå‘çŽ°ä¸¤ä¸ªè¿”å›žReferencedPropertyçš„æ³›åž‹æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªç”¨äºŽvarï¼Œç¬¬äºŒä¸ªç”¨äºŽvalã€‚çŽ°åœ¨è®©æˆ‘ä»¬ç”¨ref()ç®€åŒ–ä»£ç  class Component : ComponentInterface { private val navigable: Navigable = NavigableImpl() private val searchable: Searchable = SearchableImpl() override val onNavigationClick by ref(navigable::onNavigationClick) override var searchText by ref(searchable::searchText) } å¸Œæœ›çœ‹å®Œè¿™ä¸‰ç« ä½ èƒ½æœ‰äº›è®¸æ”¶èŽ·ã€‚ å‚è€ƒ6 magic sugars that can make your Kotlin codebase happier â€” Part 3]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>syntax</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Kotlinè¯­æ³•ç³– Part2]]></title>
    <url>%2F2019%2F03%2F30%2Fkotlin%E8%AF%AD%E6%B3%95%E7%B3%96Part2%2F</url>
    <content type="text"><![CDATA[å‰è¨€åœ¨ç¬¬ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¼šäº†å¦‚ä½•ä½¿ç”¨sealed classesï¼Œä»¥åŠwhen()é…åˆPairæˆ–Tripleä½¿ç”¨åšå¤šé‡æ¡ä»¶åˆ¤æ–­ã€‚ åœ¨è¿™ä¸€ç« ä¸­ï¼Œæˆ‘æƒ³è·Ÿå¤§å®¶åˆ†äº«ä¸€ä¸‹with()å’Œinline reifiedçš„åŸºæœ¬ä½¿ç”¨ã€‚ ä½¿ç”¨with()å‡½æ•°with()å‡½æ•°ä½äºŽStandard.ktï¼Œæ˜¯Kotlinæ ‡å‡†å‡½æ•°ä¹‹ä¸€ï¼Œå¤§å®¶å¯ä»¥çœ‹çœ‹ï¼ŒæŽŒæ¡å¥½è¿™äº›å‡½æ•°å¯¹äºŽæˆ‘ä»¬ç®€åŒ–ç¼–ç¨‹æœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œæœ‰æ—¶é—´æˆ‘ä¼šå¦å¼€ä¸€ç« åˆ†äº«æˆ‘å¹³æ—¶ä½¿ç”¨åˆ°å®ƒä»¬çš„åœ°æ–¹ï¼Œå½“ç„¶ä¹Ÿéžå¸¸æ¬¢è¿Žå¤§å®¶è¯„è®ºåˆ†äº«ä½¿ç”¨æŠ€å·§ã€‚å‡è®¾ä½ ä»Žæœªä½¿ç”¨è¿‡with()å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹æºç ï¼š inline fun &lt;T, R> with(receiver: T, block: T.() -> R): R Calls the specified function block with the given receiver as its receiver and returns its result. å¤§ä½“çš„æ„æ€æ˜¯è°ƒç”¨receiverä¸­çš„æ–¹æ³•ç„¶åŽè¿”å›žå®ƒçš„ç»“æžœï¼š val receiver: String = "Fructos" val block: String() -> Unit = { println(toUpperCase()) println(toLowerCase()) println(capitalize()) } val result: Unit = with&lt;String, Unit>(receiver, block) //ç®€åŒ–ä¸€ä¸‹ä»£ç  with(sugar) { println(toUpperCase()) println(toLowerCase()) println(capitalize()) } åœ¨blockä¸­ä½ å¯ä»¥è°ƒç”¨åˆ°receiverçš„æ–¹æ³•è€Œä¸”ä¸éœ€è¦ä»»ä½•é™å®šç¬¦ï¼Œåœ¨blockçš„æœ€åŽè¿”å›žä½ éœ€è¦çš„æ•°æ®ç±»åž‹å°±å¯ä»¥äº†ã€‚åœ¨é¡¹ç›®ä¸­æˆ‘ç»å¸¸ä½¿ç”¨å®ƒåœ¨på±‚ä¼ é€’é™å®šç¬¦åƒæ˜¯view.show(),view.hide() interface View { fun show() fun hide() fun reset() fun clear() } class Presenter(private val view: View) { fun present(isFructos:Boolean) = with(view) { if(isFructos) { show() hide() } else { hide() clear() } } } inline reifiedæˆ‘ä»¬å…ˆåˆ†æžä¸€ä¸‹ä¸‹é¢çš„ä»£ç  abstact class Item class MediaItem: Item() { val media = ... } class IconItem: Item() { val icon = ... } interface Renderer { fun render(view: View, item:Item) } class MediaItemRenderer: Renderer { override fun render(view: View, item: Item) { if(item !is MediaItem) { throw AssertionError("Item is not an instance of MediaItem") } view.showMedia(item.media) view.reset() } } class IconItemRenderer: Renderer { override fun render(view: Viewm, item: Item) { if(item !is IconItem) { throw AssertionError("Item is not an instance of IconItem") } view.showIcon(item.icon) view.reset() } } ä¸Šè¿°ä»£ç æœ‰å¾ˆå¤šå†—ä½™çš„åœ°æ–¹ï¼Œå…¶å®žå¾ˆæ˜Žæ˜¾ä½ å°±èƒ½çœ‹å‡ºMediaItemRendererå’ŒIconItemRendereråœ¨render()å‡½æ•°ä¸­å­˜åœ¨ç€ç›¸åŒçš„é€»è¾‘ï¼ŒçŽ°åœ¨ï¼Œæˆ‘ä»¬ç”¨inline reifiedæ¥æ”¹é€ å®ƒï¼Œé¦–å…ˆå°†renderå‡½æ•°ä¸­çš„é€»è¾‘æå–å‡ºæ¥ï¼š fun&lt;T> withCorrectType(toBeChecked: Item, block: (T) -> Unit) { if(toBeChecked !is T) { throw IllegalArgumentException("invalid Type") } block.invoke(toBeChecked) } ç„¶è€Œï¼Œè¿™æ ·åšå¹¶ä¸èƒ½é€šè¿‡ç¼–è¯‘ï¼Œä¼šæŠ¥é”™ Cannot check for instance of erased type: T äº§ç”Ÿè¿™ç§é”™è¯¯æ˜¯å› ä¸ºæ³›åž‹æœºåˆ¶ã€‚ During the type erasure process, the Java compiler erases all type parameters and replaces each with its first bound if the type parameter is bounded,or Object if the type parameter is unbounded.-docs.oracle.com so, å¯ä»¥é˜²æ­¢é˜²æ­¢æ³›åž‹Tè¢«æ¸…é™¤å—ï¼Ÿåœ¨Kotlinä¸­ä¸€åˆ‡éƒ½æœ‰å¯èƒ½ï¼Œä½¿ç”¨inline reifiedï¼Œå°±èƒ½ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚ class MediaItemRenderer: Renderer { override fun render(view: View, item: Item) = with(view) { withCorrectType&lt;MediaItem>(item) { show {it.media()} reset() } } } class IconItemRenderer: Renderer { override fun render(view: View, item: Item) = with(view) { withCorrectType&lt;IconItem>(item) { clear() show {it.icon()} } } } inline fun&lt;reified T> withCorrectType(toBeChecked: Item, block: (T) -> Unit) { if(toBeChecked !is T) { throw ... } block.invoke(toBeChecked) } ä½¿ç”¨reifiedä¿®é¥°ç¬¦Kotlin compilerä¿ç•™äº†ä½ çš„ç±»åž‹ï¼Œå½“ç„¶è¿™æ˜¯å¿…é¡»åœ¨ä½¿ç”¨inlineçš„å‰æä¸‹ã€‚ ä»¥ä¸Šå°±æ˜¯ç¬¬äºŒç« çš„å…¨éƒ¨äº†ï¼Œåœ¨ç¬¬ä¸‰ç« ä¸­æˆ‘ä»¬å°†å±•ç¤ºæ›´å¤šçš„Kotlinå°æŠ€å·§ã€‚ å‚è€ƒ6 magic sugars that can make your Kotlin codebase happier â€” Part 2]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>syntax</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Kotlinè¯­æ³•ç³– Part1]]></title>
    <url>%2F2019%2F03%2F23%2Fkotlin%E8%AF%AD%E6%B3%95%E7%B3%96Part1%2F</url>
    <content type="text"><![CDATA[Kotlinç»™æˆ‘ä»¬æä¾›äº†å¤§é‡çš„å·¥å…·å’Œè¯­æ³•ç³–è®©æˆ‘ä»¬èƒ½å¤Ÿæ›´ä¸ºä¾¿åˆ©çš„åŽ»ç¼–ç¨‹ï¼Œè®©ä»£ç æœ‰æ›´å¥½çš„å¯è¯»æ€§å’Œå¯æ‰©å±•æ€§ã€‚å†™æ›´å°‘çš„ä»£ç åšæ›´å¤šçš„äº‹ï¼Œç”¨è¿™å¥è¯æ¦‚æ‹¬Kotlinå’ŒJavaä¹‹é—´çš„å·®å¼‚ä¸€ç‚¹éƒ½ä¸ä¸ºè¿‡ã€‚é¢å¯¹Kotlinè¿™ç§èƒ½å‡è½»æˆ‘ä»¬å·¥ä½œé‡çš„å·¥å…·ï¼Œæˆ‘ä»¬æœ‰ä»€ä¹ˆç†ç”±ä¸åŽ»å­¦ä¹ å®ƒå‘¢ï¼Ÿæˆ‘ç›¸ä¿¡æœ‰æ•ˆåœ°ä½¿ç”¨Kotlinä¼šå¯¹ä½ çš„èº«å¿ƒå¸¦æ¥å·¨å¤§çš„æ„‰æ‚¦ï¼Œåœ¨ä½¿ç”¨Kotlinçš„è¿‡ç¨‹ä¸­ï¼Œå®ƒçš„ç®€æ´å’Œä¼˜é›…çš„è¯­æ³•ä¸æ–­åœ°ç»™æˆ‘å¸¦æ¥æƒŠå–œï¼Œå¯èƒ½è¿™ä¹Ÿæ˜¯Googleä½¿ç”¨å®ƒä½œä¸ºAndroidå®˜æ–¹ç¼–ç¨‹è¯­è¨€çš„åŽŸå› å§ã€‚Kotlinçš„è¯­æ³•ç³–æœ‰å¾ˆå¤šï¼Œæˆ‘è‡³ä»Šä¹Ÿè¿˜åœ¨å­¦ä¹ ä¸­ï¼ŒæŽ¥ä¸‹æ¥æˆ‘å°†ç”¨ä¸‰ç¯‡æ–‡ç« çš„ç¯‡å¹…å°†ç›®å‰æˆ‘ä½¿ç”¨è¾ƒå¤šçš„ä»‹ç»ç»™å¤§å®¶ã€‚è¿™ç¯‡æ–‡ç« æ˜¯è¿™ä¸ªç³»åˆ—çš„ç¬¬ä¸€ç« ï¼Œåœ¨è¿™å¼ ä¸­æˆ‘ä»¬ä¸»è¦æ¥äº†è§£ä¸‹å¯†å°ç±»(sealed class)çš„ç”¨æ³•ã€‚ å¯†å°ç±»(sealed class)ç”¨sealedå…³é”®å­—ä¿®é¥°çš„ç±»æˆ‘ä»¬ç§°ä¹‹ä¸ºå¯†å°ç±»ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ˜¯è¿™ä¹ˆä»‹ç»çš„ å¯†å°ç±»ç”¨æ¥è¡¨ç¤ºå—é™çš„ç±»ç»§æ‰¿ç»“æž„ï¼Œå½“ä¸€ä¸ªå€¼ä¸ºæœ‰é™é›†ä¸­çš„ç±»åž‹ã€è€Œä¸èƒ½æœ‰ä»»ä½•å…¶ä»–ç±»åž‹ã€‚ è¿™æ˜¯ä¸æ˜¯å¾ˆæžšä¸¾ç±»å¾ˆç›¸ä¼¼å‘¢ï¼Œæˆ‘è®¤ä¸ºsealed classæ¯”æžšä¸¾çš„ç”¨æ³•æ›´ä¸ºçµæ´»ï¼Œæ¯ä¸ªæžšä¸¾ç±»åªèƒ½å­˜åœ¨ä¸€ä¸ªå®žä¾‹ï¼Œä½†æ˜¯å¯†å°ç±»çš„å­ç±»å¯ä»¥åŒ…å«å¤šä¸ªä¸åŒå†…éƒ¨çŠ¶æ€çš„å®žä¾‹ã€‚ä¸Šä»£ç  sealed class Response data class Success(val body: String): Response() data class Error(val code: Int, val message: String): Response() object Timeout: Response() sealed class è‡ªèº«æŠ½è±¡ï¼Œå®ƒä¸èƒ½ç›´æŽ¥å®žä¾‹åŒ–ï¼Œä½†æ˜¯å¯ä»¥æœ‰abstractæˆå‘˜ã€‚æˆ‘ä»¬ä½¿ç”¨IntelliJ IDEA Kotlin Bytecodeå·¥å…·å°†ä¸Šé¢çš„ä»£ç è¿˜åŽŸç¨‹Javaä»£ç ã€‚ 1.Reveal Koltin Bytecode 2.Decompile Kotlin Bytecode to Java code ç»è¿‡è¿™å‡ æ­¥ï¼Œå°±å¯ä»¥å¼€å§‹é˜…è¯»è½¬æ¢åŽJavaä»£ç äº† public abstract class Response { private Response() { } // $FF: synthetic method public Response(DefaultConstructorMarker $constructor_marker) { this(); } } ä½ å¯èƒ½å·²ç»åœ¨æƒ³ï¼Œseald classesä¸“é—¨ä¸ºç»§æ‰¿è€Œç”Ÿï¼Œå› æ­¤ä»–ä»¬æ˜¯æŠ½è±¡çš„ã€‚ä½†æ˜¯ï¼Œä»–ä»¬æ€Žä¹ˆä¼šç±»ä¼¼enums?ä¸‹é¢æ˜¯Kotlinç¼–è¯‘å™¨é€šè¿‡å…è®¸æ‚¨ä½¿ç”¨Responseç±»çš„å­ç±»ä½œä¸º(as case of)whenï¼ˆï¼‰å‡½æ•°çš„æ¡ä»¶æ—¶ç»™æ‚¨å¸¦æ¥å·¨å¤§å¸®åŠ©çš„æ—¶å€™äº†ã€‚å¦å¤–ï¼Œkotlinæä¾›äº†æžå¤§çš„çµæ´»æ€§(flexibility)ï¼Œç»§æ‰¿sealed classçš„å¯¹è±¡å¯ä»¥æ˜¯ä¸€ä¸ªdata class(æ•°æ®ç±»)æˆ–object fun sugar(response: Response) = when (response) { is Success -> ... is Error -> ... Timeout -> ... } è¿™æ ·çš„ä»£ç çœ‹ä¸ŠåŽ»ä¸ä»…ä»…æ˜¯ç»“æž„æ¸…æ™°ï¼Œåœ¨ä½¿ç”¨å®ƒæ—¶ï¼Œä½ ç”šè‡³ä¸ç”¨åŽ»åšé¢å¤–çš„å¼ºåˆ¶è½¬æ¢ï¼Œåœ¨æ¡ä»¶è¯­å¥çš„æœ€åŽä¹Ÿä¸å†éœ€è¦elseå­å¥äº†ï¼Œæˆ‘ä»¬å·²ç»è¦†ç›–äº†æ‰€æœ‰çš„æƒ…å†µã€‚ fun sugar(response: Response) = when (response) { is Success -> println(response.body) is Error -> println("${response.code} ${response.message}") Timeout -> println(response.javaClass.simpleName) } ä¸ä½¿ç”¨sealedå…³é”®å­—çš„ä»£ç æ˜¯æ€Žæ ·çš„ï¼Ÿå¯ä»¥ç”¨IntelliJ IDEA Kotlin Bytecodeè½¬æ¢æˆJavaçœ‹ä¸‹ public final void sugar(@NotNull Response response) { Intrinsics.checkParameterIsNotNull(response, "response"); String var3; if (response instanceof Success) { var3 = ((Success)response).getBody(); System.out.println(var3); } else if (response instanceof Error) { var3 = "" + ((Error)response).getCode() + ' ' + ((Error)response).getMessage(); System.out.println(var3); } else { if (!Intrinsics.areEqual(response, Timeout.INSTANCE)) { throw new NoWhenBranchMatchedException(); } var3 = response.getClass().getSimpleName(); System.out.println(var3); } } å¯è§ä½¿ç”¨Kotlinæˆ‘ä»¬å‡å°‘äº†å¤šå°‘ä»£ç é‡ã€‚ ä½¿ç”¨when()æ–¹æ³•è‡ªç”±çš„æŽ’åˆ—ç»„åˆæŽ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹æžšä¸¾ç±»å’Œwhen()çš„é…åˆã€‚ enum class Employee { DEV_LEAD, SENIOR_ENGINEER, REGULAR_ENGINEER, JUNIOR_ENGINEER } enum class Contract { PROBATION, PERMANENT, CONTRACTOR, } Employeeæžšä¸¾å®šä¹‰äº†Companyä¸­çš„æ‰€æœ‰è§’è‰²ï¼ŒContractæžšä¸¾åŒ…å«äº†æ‰€æœ‰ç±»åž‹çš„å‘˜å·¥åˆåŒã€‚é€šè¿‡è¿™ä¸¤ä¸ªæžšä¸¾çš„æŽ’åˆ—ç»„åˆæˆ‘ä»¬è¦è¿”å›žæ­£ç¡®çš„SafariBookAccessã€‚ fun access(employee: Employee, contract: Contract): SafariBookAccess ç„¶åŽç”¨å®šä¹‰SafariBooksAccess sealed class SafariBookAccess data class Granted(val expirationDate: DateTime) : SafariBookAccess() data class NotGranted(val error: AssertionError) : SafariBookAccess() data class Blocked(val message: String) : SafariBookAccess() åœ¨access()æ–¹æ³•ä¸­åšæŽ’åˆ—ç»„åˆ fun access(employee: Employee, contract: Contract): SafariBookAccess { return when (employee) { SENIOR_ENGINEER -> when (contract) { PROBATION -> NotGranted(AssertionError("Access not allowed on probation contract.")) PERMANENT -> Granted(DateTime()) CONTRACTOR -> Granted(DateTime()) } REGULAR_ENGINEER -> when (contract) { PROBATION -> NotGranted(AssertionError("Access not allowed on probation contract.")) PERMANENT -> Granted(DateTime()) CONTRACTOR -> Blocked("Access blocked for $contract.") } JUNIOR_ENGINEER -> when (contract) { PROBATION -> NotGranted(AssertionError("Access not allowed on probation contract.")) PERMANENT -> Blocked("Access blocked for $contract.") CONTRACTOR -> Blocked("Access blocked for $contract.") } else -> throw AssertionError() } } emmï¼Œè¿™æ ·å†™ä¸å¤Ÿç®€æ´ï¼Œä¸Šè¿°ä»£ç å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š è¿‡å¤šçš„when()æ–¹æ³•ã€‚å¯ä»¥ç”¨Pairé¿å…åµŒå¥—(nesting) æ”¹å˜æžšä¸¾ç±»å‚æ•°çš„é¡ºåºï¼Œä½¿ç”¨Pair&lt;Contract, Employee&gt;()æé«˜å¯è¯»æ€§ å°†è¿”å›žç›¸åŒçš„caseåˆå¹¶ æ”¹ä¸ºå•è¡¨è¾¾å¼å‡½æ•°(Single-Expression functions) ç„¶åŽï¼Œæˆ‘ä»¬æ¥æ”¹é€ ä¸€ä¸‹è¿™æ®µä»£ç  fun access(contract: Contract, employee: Employee) = when (Pair(contract, employee)) { Pair(PROBATION, SENIOR_ENGINEER), Pair(PROBATION, REGULAR_ENGINEER), Pair(PROBATION, JUNIOR_ENGINEER) -> NotGranted(AssertionError("Access not allowed on probation contract.")) Pair(PERMANENT, SENIOR_ENGINEER), Pair(PERMANENT, REGULAR_ENGINEER), Pair(PERMANENT, JUNIOR_ENGINEER), Pair(CONTRACTOR, SENIOR_ENGINEER) -> Granted(DateTime(1)) Pair(CONTRACTOR, REGULAR_ENGINEER), Pair(CONTRACTOR, JUNIOR_ENGINEER) -> Blocked("Access for junior contractors is blocked.") else -> throw AssertionError("Unsupported case of $employee and $contract") } çŽ°åœ¨çœ‹ä¸ŠåŽ»æ˜¯ä¸æ˜¯å¾ˆç®€æ´äº†ï¼Œä½†æ˜¯è¿˜èƒ½æ›´åŠ ç®€æ´ï¼š fun access(contract: Contract, employee: Employee) = when (contract to employee) { PROBATION to SENIOR_ENGINEER, PROBATION to REGULAR_ENGINEER -> NotGranted(AssertionError("Access not allowed on probation contract.")) PERMANENT to SENIOR_ENGINEER, PERMANENT to REGULAR_ENGINEER, PERMANENT to JUNIOR_ENGINEER, CONTRACTOR to SENIOR_ENGINEER -> Granted(DateTime(1)) CONTRACTOR to REGULAR_ENGINEER, PROBATION to JUNIOR_ENGINEER, CONTRACTOR to JUNIOR_ENGINEER -> Blocked("Access for junior contractors is blocked.") else -> throw AssertionError("Unsupported case of $employee and $contract") } å¸Œæœ›è¿™äº›è¯­æ³•ç³–èƒ½å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œå‰©ä¸‹çš„æˆ‘ä»¬å°†åœ¨Part2ä¸­è®²è§£ã€‚ è½¬è‡ª Piotr Åšlesarew @ Medium 6 magic sugars that can make your Kotlin codebase happier â€” Part 1ç¼–å†™ snoopy@we1code.cn]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>syntax</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Kotlinä½œç”¨åŸŸå‡½æ•°(Scope Functions)]]></title>
    <url>%2F2019%2F03%2F22%2FKotlin%E5%9F%BA%E7%A1%80-%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%87%BD%E6%95%B0%2F</url>
    <content type="text"><![CDATA[å‰è¨€Kotlinä¸­æœ‰5ç§ä½œç”¨åŸŸå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š let, run, with, apply, and also å®ƒä»¬å¹¶æ²¡æœ‰ä»»ä½•ç‰¹æ€§ï¼Œä½†æ˜¯ä½¿ç”¨ä»–ä»¬å¯ä»¥è®©æˆ‘ä»¬çš„ä»£ç æ›´åŠ ç®€æ´ï¼Œå…·å¤‡æ›´å¥½çš„å¯è¯»æ€§ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™æ‰¾åˆ°å®ƒä»¬çš„æºç ã€‚ä¸‹é¢æˆ‘å°†åˆ†æžè¿™äº›æ–¹æ³•çš„åŒºåˆ«ã€‚ åˆ†æžå¯ä»¥çœ‹åˆ°å…¶å®žæ–‡æ¡£ä¸Šå·²ç»æœ‰è¯´æ˜Žäº†ï¼Œå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«åœ¨äºŽï¼š å¼•ç”¨ä¸Šä¸‹æ–‡çš„æ–¹å¼ è¿”å›žå€¼ æ¯ä¸ªä½œç”¨åŸŸå‡½æ•°ä½¿ç”¨ä¸¤ç§è®¿é—®ä¸Šä¸‹æ–‡å¯¹è±¡çš„æ–¹å¼ä¹‹ä¸€ï¼šä½œä¸ºlambdaæŽ¥æ”¶å™¨ï¼ˆthisï¼‰æˆ–ä½œä¸ºlambdaè‡ªå˜é‡ï¼ˆitï¼‰ã€‚ä¸¤è€…éƒ½æä¾›ç›¸åŒçš„åŠŸèƒ½ï¼Œå› æ­¤æˆ‘å°†æè¿°åœ¨æ¯ç§æƒ…å†µä¸‹çš„åˆ©å¼Šï¼Œå¹¶æä¾›æœ‰å…³å…¶ç”¨æ³•çš„å»ºè®®ã€‚ thisrun, with, applyé€šè¿‡å…³é”®å­—thiså°†ä¸Šä¸‹æ–‡ä½œä¸ºlambdaçš„æŽ¥æ”¶å™¨ã€‚å› æ­¤ï¼Œåœ¨å…¶lambdaä¸­ï¼Œè¯¥å¯¹è±¡çš„ç”¨æ³•è·Ÿåœ¨æ™®é€šç±»å‡½æ•°ä¸­ä¸€æ ·ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯ä»¥çœç•¥thisç›´æŽ¥ä½¿ç”¨æŽ¥æ”¶å™¨å¯¹è±¡çš„æˆå‘˜å˜é‡ï¼Œä»Žè€Œä½¿ä»£ç æ›´åŠ ç®€æ´ã€‚ä½†æ˜¯å¦‚æžœçœç•¥äº†thisï¼Œå°±å¾ˆéš¾åŒºåˆ†å‡ºæŽ¥æ”¶å™¨å¯¹è±¡çš„æˆå‘˜å˜é‡å’Œå¤–éƒ¨å˜é‡æˆ–æ–¹æ³•ã€‚å› æ­¤ï¼Œå¦‚æžœåœ¨lambdaä¸­æ“ä½œå¯¹è±¡ï¼Œåƒæ˜¯è°ƒç”¨å®ƒçš„æ–¹æ³•æˆ–æ˜¯ç»™å±žæ€§èµ‹å€¼ï¼ŒæŽ¨èä½¿ç”¨è¿™ä¸‰ç§ä½œç”¨åŸŸå‡½æ•°ã€‚ itlet, alsoå°†ä¸Šä¸‹æ–‡å¯¹è±¡ä½œä¸ºlambdaè¡¨è¾¾å¼çš„å‚æ•°ã€‚å¦‚æžœåœ¨ä½œç”¨åŸŸä¸­æ²¡æœ‰å®šä¹‰å‚æ•°åï¼Œåˆ™é»˜è®¤ä¸ºitã€‚itæ¯”thisæ›´çŸ­ï¼Œä½¿ç”¨itçš„è¡¨è¾¾å¼æ›´åŠ æ˜“è¯»ã€‚ä½†æ˜¯åœ¨è°ƒç”¨å¯¹è±¡æ–¹æ³•å’Œå‚æ•°æ—¶ï¼Œä¸èƒ½åƒthisä¸€æ ·éšå¼è°ƒç”¨ã€‚å› æ­¤ï¼Œå½“å¯¹è±¡è¢«ç”¨ä½œæ–¹æ³•å‚æ•°æ—¶ï¼ŒæŽ¨èä½¿ç”¨è¿™ä¸¤ç§ä½œç”¨åŸŸå‡½æ•°ã€‚ è¿”å›žå€¼ apply, also è¿”å›žä¸Šä¸‹æ–‡å¯¹è±¡ let, run, with è¿”å›žlambdaè¡¨è¾¾å¼çš„ç»“æžœ å¦‚ä½•é€‰æ‹©ä½¿ç”¨ä¸ºäº†æ›´æ–¹ä¾¿æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ï¼Œå®˜æ–¹ç»™å‡ºäº†ä¸å°‘ç¤ºä¾‹ letlet å¯ä»¥è¢«ç”¨åœ¨åœ¨è°ƒç”¨é“¾çš„ç»“æžœä¸Šæ‰§è¡Œä¸€ä¸ªæˆ–è€…å¤šä¸ªæ–¹æ³•ã€‚ val numbers = mutableListOf("one", "two", "three", "four", "five") numbers.map { it.length }.filter { it > 3 }.let { println(it) // and more function calls if needed } å¦‚æžœä»£ç å—ä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶å°†itä½œä¸ºå‚æ•°ï¼Œå¯ä»¥å°†lambdaç®€å†™æˆ(::) val numbers = mutableListOf("one", "two", "three", "four", "five") numbers.map { it.length }.filter { it > 3 }.let(::println) letç»å¸¸è¢«ç”¨åœ¨æ‰§è¡Œnon-null valuesçš„ä»£ç å—ã€‚è¦å¯¹éžç©ºå¯¹è±¡è¿›è¡Œæ“ä½œï¼Œéœ€è¦ä½¿ç”¨å®‰å…¨æ“ä½œç¬¦?. val str: String? = "Hello" //processNonNullString(str) // compilation error: str can be null val length = str?.let { println("let() called on $it") processNonNullString(it) // OK: 'it' is not null inside '?.let { }' it.length } withå®˜æ–¹å»ºè®®ä½¿ç”¨withä¸è¿”å›žç»“æžœ(â€œwith this object, do the following.â€)ï¼Œå¦‚ä¸‹ï¼š val numbers = mutableListOf("one", "two", "three") with(numbers) { println("'with' is called with argument $this") println("It contains $size elements") } runå½“ä½ çš„lambdaè¡¨è¾¾å¼ä¸­å«æœ‰å¯¹è±¡çš„åˆå§‹åŒ–å’Œè¿”å›žå€¼çš„è®¡ç®—æ—¶runå°±å¾ˆæœ‰ç”¨äº†ã€‚ val service = MultiportService("https://example.kotlinlang.org", 80) val result = service.run { port = 8080 query(prepareRequest() + " to port $port") } // the same code written with let() function: val letResult = service.let { it.port = 8080 it.query(it.prepareRequest() + " to port ${it.port}") } applyä¸»è¦ç”¨ä½œæ“ä½œæŽ¥æ”¶å¯¹è±¡çš„æˆå‘˜ï¼Œæœ€å…¸åž‹çš„ä¾‹å­å°±æ˜¯å¯¹è±¡çš„é…ç½®ã€‚å¯ä»¥ç†è§£æˆâ€apply the following assignments to the objectâ€ã€‚ val adam = Person("Adam").apply { age = 32 city = "London" } å°†æŽ¥æ”¶å¯¹è±¡ä½œä¸ºè¿”å›žå€¼ï¼Œä½ èƒ½å¾ˆå®¹æ˜“çš„å°†applyç½®å…¥è°ƒç”¨é“¾ä¸­åšæ›´ä¸ºå¤æ‚çš„å¤„ç†ã€‚ alsoalsoé€‚ç”¨äºŽå°†ä¸Šä¸‹æ–‡å¯¹è±¡ä½œä¸ºå‚æ•°çš„æ“ä½œã€‚alsoå¯ä»¥ç”¨ä½œä¸æ”¹å˜å¯¹è±¡çš„é¢å¤–æ“ä½œï¼Œåƒæ˜¯æ‰“å°æ—¥å¿—æˆ–æ‰“å°è°ƒè¯•ä¿¡æ¯ã€‚é€šå¸¸ï¼Œä½ å¯ä»¥ä»Žè°ƒç”¨é“¾ä¸­ç§»é™¤alsoè€Œä¸ä¼šç ´åç¨‹åºåŽŸæœ‰çš„é€»è¾‘ã€‚å¯ä»¥å°†alsoç†è§£æˆâ€and also do the followingâ€ã€‚ æ€»ç»“å¯ä»¥å‚è€ƒä¸‹é¢çš„æµç¨‹å›¾ å®˜æ–¹ç»™å‡ºçš„å¯¹æ¯”è¡¨æ ¼ï¼š Function Object reference Return value Is extension function let it Lambda result Yes run this Lambda result Yes run - Lambda result No: called without the context object with this Lambda result No: takes the context object as an argument apply this Context object Yes also it Context object Yes ä¸€å¥è¯æ€»ç»“ï¼š å¯¹éžç©ºå¯¹è±¡æ‰§è¡Œlambdaï¼šlet å°†è¡¨è¾¾å¼ä½œä¸ºå±€éƒ¨å˜é‡å¼•å…¥ï¼šlet å¯¹è±¡é…ç½®ï¼šapply å¯¹è±¡é…ç½®å¹¶è®¡ç®—ç»“æžœï¼šrun éœ€è¦è¡¨è¾¾å¼çš„è¿è¡Œè¯­å¥ï¼šno-extension run é¢å¤–çš„æ“ä½œï¼šalso å°†å¯¹è±¡çš„è°ƒç”¨æ–¹æ³•åˆ†ç»„ï¼šwith æ€»ç»“è¯­å°½ç®¡ä½œç”¨åŸŸæ–¹æ³•å¯ä»¥ä½¿ä»£ç æ›´ä¸ºç®€æ´ï¼Œä½†æ˜¯è¯·é¿å…è¿‡åº¦ä½¿ç”¨å®ƒï¼šè¿™æ ·ä¼šå‡å°‘ä»£ç çš„å¯è¯»æ€§å¹¶ä¸”å¯èƒ½å¯¼è‡´é”™è¯¯ã€‚é¿å…åµŒå¥—ä½œç”¨åŸŸå‡½æ•°ï¼Œé“¾å¼è°ƒç”¨å®ƒä»¬çš„æ—¶å€™è¦æ ¼å¤–å°å¿ƒã€‚ å‚è€ƒä½œç”¨åŸŸå‡½æ•°kotlin standard function]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>syntax</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Kotlin Lambda and Extension]]></title>
    <url>%2F2019%2F03%2F22%2Fkotlin%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95%2F</url>
    <content type="text"><![CDATA[Extension Function(æ‰©å±•å‡½æ•°) Extension Function èƒ½åœ¨å·²ç»å­˜åœ¨çš„ç±»ä¸­æ·»åŠ æ–°çš„æ–¹æ³•æˆ–è€…å±žæ€§ï¼Œå³ä½¿è¿™äº›ç±»æ¥è‡ªåº“æˆ–è€…SDKä¸­ã€‚åœ¨å‡½æ•°å†…éƒ¨ï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®ç±»çš„å…¬å…±å‡½æ•°å’Œå±žæ€§è€Œä¸éœ€è¦ä»»ä½•é™å®šç¬¦ï¼Œå°±å¥½åƒè¿™ä¸ªå‡½æ•°å°±åœ¨è¿™ä¸ªç±»çš„å†…éƒ¨ä¸€æ ·ã€‚ï¼ˆæ³¨æ„ï¼šä»ŽæŠ€æœ¯ä¸Šå°†ï¼Œå®ƒå¹¶æ²¡æœ‰ä¿®æ”¹çŽ°æœ‰ç±»ï¼Œåªæ˜¯åœ¨å£°æ˜Žçš„ç±»ä¸­åˆ›å»ºäº†static public finalå‡½æ•°ï¼‰ ä¸¾ä¸ªæ —å­ object KotMain { @JvmStatic fun main(args: Array&lt;String>) { val person = "snoopy" person.say("hello") } fun String.say(sth: String) { println("$this say $sth") } } åç¼–è¯‘åŽæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„javaä»£ç  public final class KotMain { public static final KotMain INSTANCE; public static final void main(@NotNull String[] args) { Instrinsics.checkParameterIsNotNull(args, "args"); String person = "snoopy"; INSTANCE.say(person, "hello"); } public final void say(@NotNull String $this$say, @NotNull String sth) { Instrinsics.checkParameterIsNotNull($this$say, "$this$say"); Instrinsics.checkParameterIsNotNull(sth, "sth"); String var3 = $this$say + ' ' + sth; System.out.println(var3); } } å¯ä»¥çœ‹åˆ°åªæ˜¯å¢žåŠ äº†ä¸€ä¸ªfinalæ–¹æ³•ã€‚ æŽ¥ä¸‹æ¥çœ‹çœ‹å¦‚ä½•åœ¨Androidé¡¹ç›®ä¸­è¿ç”¨å®ƒ å¯ä»¥ç”Ÿæˆä»»ä½•Android Viewå®žä¾‹çš„å‡½æ•° inline fun&lt;reified V: View> v(context: Context, init: V.() -> Unit): V{ val instance = V::class.java.getConstructor(context::class.java) val view = instace.newInstance(context) view.init() return view } dp-pxæ‹“å±• fun View.dp2px(dp: Float) { return TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dp, context.resource.displayMetrics) } æ·»åŠ fragment inline fun FragmentManager.inTransaction(func: FragmentTransaction.() -> Unit) { val fragmentTransaction = begainTransaction() fragmentTransaction.func() fragmentTransaction.commit() } //ä½¿ç”¨ supportFragmentManager.inTransaction { add(R.id.container, fragment) //other operation } High Order FunctionHigh Order Function åœ¨ kotlin çš„å®˜ç½‘ä¸­æœ‰å¾ˆæ˜Žç¡®çš„è§£é‡Š: Higher-Order FunctionsA higher-order function is a function that takes functions as parameters, or returns a function.é«˜é˜¶å‡½æ•°æ˜¯å°†å‡½æ•°ä½œä¸ºå‚æ•°æˆ–è¿”å›žå‡½æ•°çš„å‡½æ•°ã€‚ High Order Function ä¸­å‡½æ•°ä½œä¸ºå‚æ•°çš„æƒ…å†µ inline fun test1(func:Int.() -> Unit) { func(1) } inline fun Int.test2(func:Int.() -> Unit) { func() } public final void test1(int $this$test1, Function1 call) { call.invoke($this$test) } public final void test2(Function1 call) { call.invoke(1) } Lambda with Receiverä»€ä¹ˆæ˜¯Lambda with Receiver? Extension Function + Lambda = Lambda with Receiverï¼Œå®ƒå…è®¸ä½ åœ¨æ²¡æœ‰ä»»ä½•é™å®šç¬¦çš„æƒ…å†µä¸‹è°ƒç”¨lambdaä¸­å¯¹è±¡çš„æ–¹æ³•ã€‚ inline functionåœ¨kotlinä¸­ï¼Œå‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¼ é€’å‡½æ•°æˆ–è€…åƒå…¶å®ƒæ™®é€šç±»åž‹ä¸€æ ·è¿”å›žå®ƒä»¬ã€‚ç„¶è€Œï¼Œè¿™äº›å‡½æ•°åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šäº§ç”Ÿä¸€äº›æ€§èƒ½ä¸Šçš„é—®é¢˜ï¼Œå®ƒä»¬ä½œä¸ºå¯¹è±¡å­˜å‚¨é€ æˆäº†é¢å¤–çš„å†…å­˜å¼€é”€ï¼Œè¿™æ—¶å€™å°±è½®åˆ°inlineç™»åœºäº†ï¼Œåœ¨ä¸€äº›ä½¿ç”¨High Order Functionçš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç”¨inlineï¼ˆå†…è”ï¼‰åŽ»ä¿®é¥°å®ƒï¼Œè¿™æ ·å¯ä»¥å‡å°‘è°ƒç”¨å¼€é”€ã€‚æˆ‘ä»¬ä¾ç„¶ä»Žæºç å‡ºå‘ï¼Œé€šè¿‡åç¼–è¯‘ï¼Œçœ‹çœ‹ä½¿ç”¨High Order Functionç¼–è¯‘æˆJavaæ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚ object KotMain { @JvmStatic fun main(args: Array&lt;String>) { noInline { println("è°ƒç”¨ä¸­") } inlineFunc { println("è°ƒç”¨ä¸­") } } fun noInline(call: ()->Unit) { println("è°ƒç”¨å‰") call() println("è°ƒç”¨åŽ") } inline fun inlineFunc(call: ()->Unit) { println("è°ƒç”¨å‰") call() println("è°ƒç”¨åŽ") } } å†æ¥çœ‹çœ‹javaä»£ç  public final class KotMain { public static final KotlinMain INSTANCE; public static final void main(String[] args) { //no inline INSTANCE.noInline(new Function() { @Override public void invoke() { System.out.println("è°ƒç”¨ä¸­"); } }) //inline System.out.println("è°ƒç”¨å‰"); System.out.println("è°ƒç”¨ä¸­"); System.out.println("è°ƒç”¨åŽ"); } public final void noInline(Function func) { println("è°ƒç”¨å‰"); func.invoke() println("è°ƒç”¨åŽ"); } } å¤§å®¶å¯ä»¥éžå¸¸ç›´è§‚çš„çœ‹åˆ°ç»“è®ºï¼Œä¸ä½¿ç”¨å†…è”ä¿®é¥°ç¬¦ï¼Œæ¯æ¬¡è°ƒç”¨è¿™ä¸ªå‡½æ•°éƒ½ä¼šåˆå§‹åŒ–ä¸€ä¸ªFunctionå®žä¾‹ï¼Œæ˜¾ç„¶ä¼šé€ æˆå†…å­˜å¼€é”€ï¼Œè€Œä½¿ç”¨å†…è”ä¿®é¥°ç¬¦ï¼Œä¸ä¼šåˆ›å»ºFunctionå®žä¾‹ï¼Œè€Œä¼šå°†å›žè°ƒå‡½æ•°å†…éƒ¨çš„ä»£ç å¤åˆ¶åˆ°call siteä¸­ã€‚ å‚è€ƒ kotlin-extension functionKotliné‡Œçš„Extension Functionså®žçŽ°åŽŸç†åˆ†æžHow to Add a Fragment the Kotlin way]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>syntax</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Androidä»£ç æ··æ·†]]></title>
    <url>%2F2018%2F05%2F29%2FAndroid%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86%2F</url>
    <content type="text"><![CDATA[å‰è¨€æœ€è¿‘åœ¨ç”¨Kotlinæ’¸Appï¼Œå‡†å¤‡å‘ç‰ˆäº†ï¼Œåšä¸‹ä»£ç æ··æ·†ï¼Œæƒ³ç”¨åŽŸæ¥çš„æ··æ·†é€»è¾‘ï¼Œä½†æ˜¯å‘çŽ°å„ç§æŠ¥é”™ï¼Œå¤´å¤§çš„å¾ˆï¼Œè§‰å¾—æ˜¯è‡ªå·±å…³äºŽæ··æ·†çš„çŸ¥è¯†ç§¯ç´¯ä¸å¤Ÿå¤šï¼Œæ˜¯åº”è¯¥ç³»ç»Ÿçš„å­¦ä¹ ä¸€ä¸‹äº†ï¼é¡ºä¾¿åœ¨æ­¤è®°å½•ä¸‹é‡åˆ°çš„å‘ã€‚é‚£ä¸‹é¢æˆ‘ä»¬å¼€å§‹å§ã€‚ ä»£ç æ··æ·†å¼€å¯ä»£ç æ··æ·†åªè¦åœ¨app.gradleæ–‡ä»¶ä¸‹é…ç½®proguardFiles buildTypes { release { minifyEnabled true //æ˜¯å¦å¼€å¯æ··æ·† zipAlignEnabled true //å¯¹é½zip debuggable false // æ˜¯å¦debug versionNameSuffix "_release" // ç‰ˆæœ¬å‘½ååŽç¼€ proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro' // æ··æ·†æ–‡ä»¶ signingConfig signingConfigs.release } ... } proguard-android.txt æ˜¯androidè‡ªå¸¦çš„æ··æ·†è§„åˆ™ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨proguard-rules.proè¿™ä¸ªæ–‡ä»¶ä¸­é…ç½®æˆ‘ä¹ˆçš„æ··æ·†è§„åˆ™å°±å¯ä»¥äº†ã€‚ Proguardæ··æ·†æµç¨‹ åŽ‹ç¼©ï¼ˆshrinkï¼‰ï¼šæ£€æµ‹å¹¶ç§»é™¤ä»£ç ä¸­æ— ç”¨çš„ç±»ã€å­—æ®µã€æ–¹æ³•å’Œç‰¹æ€§ ä¼˜åŒ–ï¼ˆoptimizeï¼‰ï¼šå¯¹å­—èŠ‚ç è¿›è¡Œä¼˜åŒ–ï¼Œç§»é™¤æ— ç”¨æŒ‡ä»¤ æ··æ·†ï¼ˆobfuscateï¼‰ï¼šä½¿ç”¨aï¼Œbï¼Œcï¼Œdè¿™æ ·ç®€çŸ­è€Œæ— æ„ä¹‰çš„åç§°ï¼Œå¯¹ç±»ã€å­—æ®µå’Œæ–¹æ³•è¿›è¡Œé‡å‘½å é¢„æ£€ï¼ˆpreveirfyï¼‰ï¼šåœ¨javaå¹³å°ä¸Šå¯¹å¤„ç†åŽçš„ä»£ç è¿›è¡Œé¢„æ£€ï¼Œç¡®ä¿åŠ è½½çš„classæ–‡ä»¶æ—¶å¯æ‰§è¡Œçš„ æ··æ·†è§„åˆ™ Proguardå…³é”®å­— æè¿° keep ä¿ç•™ç±»å’Œç±»ä¸­çš„æˆå‘˜ï¼Œé˜²æ­¢è¢«æ··æ·†æˆ–ç§»é™¤ keepnames ä¿ç•™ç±»å’Œç±»ä¸­çš„æˆå‘˜ï¼Œé˜²æ­¢è¢«æ··æ·†ï¼Œæˆå‘˜æ²¡æœ‰è¢«å¼•ç”¨ä¼šè¢«ç§»é™¤ keepclassmembers åªä¿ç•™ç±»ä¸­çš„æˆå‘˜ï¼Œé˜²æ­¢è¢«æ··æ·†æˆ–ç§»é™¤ keepclassmembernames åªä¿ç•™ç±»ä¸­çš„æˆå‘˜ï¼Œé˜²æ­¢è¢«æ··æ·†ï¼Œæˆå‘˜æ²¡æœ‰å¼•ç”¨ä¼šè¢«ç§»é™¤ keepclasseswithmembers ä¿ç•™ç±»å’Œç±»ä¸­çš„æˆå‘˜ï¼Œé˜²æ­¢è¢«æ··æ·†æˆ–ç§»é™¤ï¼Œä¿ç•™æŒ‡æ˜Žçš„æˆå‘˜ï¼Œå‰ææ˜¯æŒ‡åçš„ç±»ä¸­çš„æˆå‘˜å¿…é¡»å­˜åœ¨ï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™è¿˜æ˜¯ä¼šæ··æ·†ã€‚ keepclasseswithmembernames ä¿ç•™ç±»å’Œç±»ä¸­çš„æˆå‘˜ï¼Œé˜²æ­¢è¢«æ··æ·†ï¼Œä¿ç•™æŒ‡æ˜Žçš„æˆå‘˜ï¼Œæˆå‘˜æ²¡æœ‰å¼•ç”¨ä¼šè¢«ç§»é™¤ï¼Œå‰ææ˜¯æŒ‡åçš„ç±»ä¸­çš„æˆå‘˜å¿…é¡»å­˜åœ¨ï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™è¿˜æ˜¯ä¼šæ··æ·†ã€‚ é€šé…ç¬¦ æè¿° field åŒ¹é…ç±»ä¸­çš„æ‰€æœ‰å­—æ®µ method åŒ¹é…ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³• init åŒ¹é…ç±»ä¸­çš„æ‰€æœ‰æž„é€ å‡½æ•° * åŒ¹é…ä»»æ„é•¿åº¦å­—ç¬¦ï¼Œä½†ä¸å«åŒ…ååˆ†éš”ç¬¦ï¼ˆ.ï¼‰ã€‚ ** åŒ¹é…ä»»æ„é•¿åº¦å­—ç¬¦ï¼Œå¹¶ä¸”åŒ…å«åŒ…ååˆ†éš”ç¬¦ï¼ˆ.ï¼‰ã€‚ *** åŒ¹é…ä»»æ„å‚æ•°ç±»åž‹ â€¦ åŒ¹é…ä»»æ„é•¿åº¦ä»»æ„ç±»åž‹å‚æ•° ä¸¾ä¾‹ï¼šæˆ‘ä»¬å®Œæ•´çš„åŒ…åæ˜¯com.xxx.ui.MainActï¼Œä½¿ç”¨com.*æˆ–è€…com.xxx.\*éƒ½æ˜¯æ— æ³•åŒ¹é…çš„ï¼Œæ­£ç¡®çš„å†™æ³•æ˜¯com.xxx.\*.\*ï¼Œæˆ–è€…com.xxx.ui.* é¿å…æ··æ·†çš„å› ç´  native methodï¼šå› ä¸ºnativeæ˜¯æ ¹æ®æ–¹æ³•ååŽ»è°ƒç”¨çš„ï¼Œè‹¥æ··æ·†åŽä¼šå¯¼è‡´æ‰¾ä¸åˆ°æ­¤æ–¹æ³•åã€‚ åå°„ç›¸å…³çš„æ–¹æ³•å’Œç±»ï¼šåå°„åŽŸç†å°±æ˜¯é€šè¿‡æ–¹æ³•åå’Œç±»ååŽ»å®žä¾‹åŒ–ç›¸åº”çš„å¯¹è±¡ï¼Œè°ƒç”¨ç›¸å…³çš„æ–¹æ³•ã€‚ setXXå’ŒgetXXæ–¹æ³•ï¼šè¿™é‡ŒæŒ‡çš„æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶ç›´æŽ¥ç”Ÿæˆç›¸åº”çš„setå’Œgetæ–¹æ³•çš„ç›¸å…³åº“ï¼Œæ‰€ä»¥javaBeanç±»å¾ˆå¤šæƒ…å†µä¸‹ä¸èƒ½åšæ··æ·†ã€‚ ç¬¬ä¸‰æ–¹jaråŒ…ï¼šè¿™ä¸ªéœ€è¦å…·ä½“æƒ…å†µå…·ä½“åˆ†æžï¼Œå¾ˆå¤šåº“éƒ½ä¼šæä¾›é»˜è®¤çš„æ··æ·†é…ç½®ï¼Œå¤§å¤šæ•°æƒ…å†µå¯ä»¥ä¸ç”¨åšæ··æ·†ã€‚ å¤„ç†æ··æ·†å¤±è´¥é—®é¢˜é€šå¸¸æ··æ·†å¤±è´¥å¯¼è‡´gradleæž„å»ºé¡¹ç›®å¤±è´¥ï¼ŒåŽŸå› åœ¨è¾“å‡ºçš„é”™è¯¯æ—¥å¿—ä¸Šå¹¶ä¸æ˜Žæ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Build Outputä¸­æ‰¾åˆ°æž„å»ºå‡ºé”™çš„taskï¼Œä¾‹å¦‚æˆ‘æž„å»ºå¤±è´¥çš„ä»»åŠ¡æ˜¯transformClassesAndResourcesWithProguardForBaiduReleaseï¼Œå› æ­¤æˆ‘å¯ä»¥æ‰§è¡Œ gradlew transformClassesAndResourcesWithProguardForBaiduRelease -- stacktrace è¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨shellä¸­çœ‹æ¸…æ¥šåˆ°åº•æ˜¯ä»€ä¹ˆåœ°æ–¹å‡ºé”™å•¦ã€‚ å‚è€ƒProGuard manualAndroidæ··æ·†Android ä»£ç æ··æ·†é›¶åŸºç¡€å…¥é—¨ProGuard æœ€å…¨æ··æ·†è§„åˆ™è¯´æ˜ŽAndroid æ··æ·†ï¼šproguardå®žè·µ]]></content>
      <categories>
        <category>Android</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[Jenkinsè‡ªåŠ¨æ‰“åŒ…Androidåº”ç”¨]]></title>
    <url>%2F2018%2F04%2F28%2Fjenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E6%89%93%E5%8C%85%2F</url>
    <content type="text"><![CDATA[å‰è¨€å·²ç»ç”¨Jenkinsåšè¿‡å¾ˆå¤šAndroidè‡ªåŠ¨åŒ–æ‰“åŒ…çš„é…ç½®äº†ï¼Œæ— å¥ˆè®°æ€§ä¸å’‹åœ°ï¼Œæ¯é…ä¸€æ¬¡å°±è¦æŸ¥ä¸€æ¬¡èµ„æ–™ï¼Œè¸©åŒæ ·çš„å‘ï¼Œæµªè´¹ä¸å°‘æ—¶é—´å’Œç²¾åŠ›ï¼Œæ›´æ˜¯è¢«ä¸€äº›èŽ«åå…¶å¦™çš„é—®é¢˜æŠ˜ç£¨åˆ°æŠ“ç‹‚ï¼ŒäºŽæ˜¯æˆ‘å†³å®šåœ¨æ­¤æŠŠJenkinsçš„é…ç½®æµç¨‹å’Œé‡åˆ°çš„å‘æ•´ç†ã€è®°å½•ä¸‹æ¥ï¼ˆå…¶å®žæ—©å°±æƒ³è¿™ä¹ˆåšäº†ï¼Œä½†æ˜¯æ‡’ç™Œæ™šæœŸï¼‰ï¼Œæ–¹ä¾¿ä»¥åŽåšä¸€äº›æŸ¥é˜…ã€‚ åŸºæœ¬æ­¥éª¤å…¨å±€å·¥å…·é…ç½®åœ¨ç³»ç»Ÿç®¡ç†ä¸­åšå…¨å±€å·¥å…·é…ç½®ï¼Œå¦‚ä¸‹å›¾é…ç½® JAVA_HOMEã€GRADLE_HOME æŒ‡å‘JDKçš„å®‰è£…ç›®å½•å’ŒGradleçš„è§£åŽ‹ç›®å½•ï¼Œç„¶åŽé…ç½®Jenkinsçš„å…¨å±€å˜é‡ï¼Œè¿™é‡Œæˆ‘é…ç½®äº†pythonçš„è·¯å¾„ï¼ŒGRADLE_USER_HOMEï¼Œè¿™ä¸ªå˜é‡ç”¨ä½œgradleçš„ç¼“å­˜ç›®å½•ï¼Œè¿˜é…ç½®äº†ANDROID_HOMEæŒ‡å‘AndroidSdkçš„ç›®å½•ã€‚ åŸºç¡€å·¥ç¨‹é…ç½®åŸºç¡€å·¥ç¨‹é…ç½®åˆ†ä¸ºé…ç½®æž„å»ºå‚æ•°ã€æºç ç®¡ç†ã€é…ç½®è§¦å‘å™¨ã€é…ç½®æž„å»ºå·¥å…·ã€æž„å»ºåŽçš„ä¸€äº›æ“ä½œ æž„å»ºä»»åŠ¡é‡å‘½å é…ç½®æž„å»ºå‚æ•°é€‰æ‹©å‚æ•°åŒ–æž„å»ºè¿‡ç¨‹&gt;é€‰é¡¹å‚æ•° æºç ç®¡ç†é€‰æ‹©gitä½œä¸ºç‰ˆæœ¬æŽ§åˆ¶å·¥å…· é…ç½®è§¦å‘å™¨è§£é‡Šä¸‹è§¦å‘å™¨çš„å„ä¸ªé€‰é¡¹ è§¦å‘è¿œç¨‹æž„å»º (ä¾‹å¦‚,ä½¿ç”¨è„šæœ¬)GitHub hook trigger for GITScm pollingå…¶ä»–å·¥ç¨‹æž„å»ºåŽè§¦å‘å®šæ—¶æž„å»ºHelp for feature: å®šæ—¶æž„å»º è½®è¯¢ SCMæ ¼å¼ä¸º *ç¬¬ä¸€ä¸ªæ˜Ÿå·è¡¨ç¤ºåˆ†é’Ÿï¼Œå–å€¼0~59ç¬¬äºŒä¸ªæ˜Ÿå·è¡¨ç¤ºå°æ—¶ï¼Œå–å€¼0~23ç¬¬ä¸‰ä¸ªæ˜Ÿå·è¡¨ç¤ºä¸€ä¸ªæœˆå†…çš„å¤©æ•°ï¼Œå–å€¼1~31ç¬¬å››ä¸ªæ˜Ÿå·è¡¨ç¤ºç¬¬å‡ ä¸ªæœˆï¼Œå–å€¼1~12ç¬¬äº”ä¸ªæ˜Ÿå·è¡¨ç¤ºä¸€å‘¨çš„ç¬¬å‡ å¤©ï¼Œå–å€¼0~7 å¤šæ¸ é“æ‰“åŒ…é…ç½®é…ç½®å‚æ•° æŽ¥å…¥å‹ç›Ÿ//build.gradle é…ç½® productFlavors { yingyongbao { } huawei { } } productFlavors.all { flavor -> flavor.manifestPlaceholders = [UMENG_CHANNEL_VALUE: name] } åŠ å›ºæˆ‘åœ¨é¡¹ç›®ä½¿ç”¨çš„æ˜¯ä¹å›ºåŠ å›ºï¼Œé¦–å…ˆåŽ»ä¸‹è½½ä»–ä»¬çš„jaråŒ…ã€‚è¿›å…¥é¡¹ç›®é…ç½®æ–‡ä»¶å¼€å§‹é…ç½®ï¼š é…ç½®æž„å»ºåŽæ“ä½œï¼Œæ‰§è¡Œæ‰“åŒ…åŽå†æ‰§è¡ŒåŠ å›ºï¼Œå¦‚ä¸‹å›¾ï¼š æŽ¥ä¸‹æ¥è½¬åˆ°åŠ å›ºé¡¹ç›®çš„é…ç½®ä¸­ï¼Œå¯ä»¥å°†ä¸‹è½½ä¸‹æ¥çš„jaråŒ…åšç‰ˆæœ¬ç®¡ç†ï¼Œä¹Ÿå¯ä»¥ç›´æŽ¥æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­ï¼Œé…ç½®æž„å»ºæ­¥éª¤ï¼š å†ç­¾åç„¶é¹…åŠ å›ºå®Œä¹‹åŽå¹¶æ²¡æœ‰ç»“æŸï¼Œéœ€è¦è¿›è¡Œå†ç­¾åï¼Œ åŠ å›ºè¿‡ç¨‹ä¸å¯é¿å…çš„ä¼šç ´åç­¾åï¼Œå› æ­¤åŠ å›ºåŽçš„åŒ…éœ€é‡ç­¾åï¼Œæœªç­¾ååº”ç”¨å°†æ— æ³•é¡ºåˆ©å®‰è£…ã€‚ è¿™é‡Œæˆ‘æ˜¯åˆå¦å¤–å»ºäº†ä¸€ä¸ªé¡¹ç›®ï¼Œåº”è¯¥è¿˜æœ‰æ¯”è¾ƒå¥½çš„åšæ³•æ¯”å¦‚æž„å»ºåŽæ‰§è¡Œä»€ä¹ˆçš„(éœ€è¦å¦è£…æ’ä»¶) ä¸»è¦çœ‹çœ‹ç­¾åè„šæœ¬æ˜¯æ€Žä¹ˆå†™çš„ import sys, os print('ä½¿ç”¨apksigerå‘½ä»¤ä¸ºapkç­¾å') files = os.listdir('./') jks_file = None apk_file = None for file in files: if file.endswith('.jks'): jks_file = file elif file.endswith('.apk'): apk_file = file else: print(file) if jks_file == None or apk_file == None: print('å½“å‰ç›®å½•ä¸å­˜åœ¨ç­¾åæ–‡ä»¶æˆ–è€…apkæ–‡ä»¶ï¼Œè¯·ç¡®è®¤ç­¾åæ–‡ä»¶åœ¨å½“å‰ç›®å½•ä¸‹') sys.exit(1) file_name=apk_file zipalign_name=file_name.split('.apk')[0]+'_zipalign.apk' command='zipalign -v -p 4 {0} {1}'.format(file_name, zipalign_name) os.system(command) jks_name=jks_file key_alias = 'bonadeTravel' ks_pass = 'bonadetravel888' key_pass = 'bonadetravel888' apk_name=zipalign_name.split('.apk')[0]+'_signed.apk' command='apksigner sign --ks {0} --ks-key-alias {1} --ks-pass pass:{2} --key-pass pass:{3} --out {4} {5}'.format(jks_name, key_alias, ks_pass, key_pass, apk_name, zipalign_name) os.system(command) æ‰§è¡Œæž„å»ºè„šæœ¬clean assemble${channel}${buildType} --stacktrace //å¦‚æžœéœ€è¦æ‰“æ‰€æœ‰æ¸ é“åŒ… assemble${buildType} --stacktrace æž„å»ºåŽçš„æ“ä½œæž„å»ºå®ŒæˆåŽçš„æ“ä½œ: æå–apkæ–‡ä»¶ ä¸Šä¼ åˆ°è’²å…¬è‹± jenkinsä¸­ç”ŸæˆäºŒç»´ç  é€šçŸ¥æµ‹è¯•äººå‘˜ tipsæƒ³ä¿®æ”¹ä¸€ä¸‹apkæ–‡ä»¶è¾“å‡ºç›®å½•ï¼ŒäºŽæ˜¯ä¿®æ”¹build.gradle applicationVariants.all { variant -> variant.outputs.each { output -> def outputFile = output.outputFile if (outputFile != null &amp;&amp; outputFile.name.endsWith('.apk')) { if(!outputFile.name.contains("debug")){ def fileName = outputFile.name.replace(".apk", "-${defaultConfig.versionName}.apk") output.outputFile = new File("C:\\Users\\user\\Desktop\\apk\\${defaultConfig.versionName}", fileName) } } } } åœ¨4.0+gradleæ–¹æ³•ç¨æœ‰ä¸åŒ applicationVariants.all { variant -> variant.outputs.all { // è‡ªå®šä¹‰è¾“å‡ºè·¯å¾„ ä½†æ˜¯getPackageApplication()å°†åœ¨19å¹´åº•è¢«ç§»é™¤ variant.getPackageApplication().outputDirectory = new File(project.rootDir.absolutePath + File.separator + "outputs") outputFileName = "AppName-${variant.flavorName}-${variant.buildType.name}-v${variant.versionName}_${time()}.apk" } æœ€ç»ˆç‰ˆæœ¬ applicationVariants.all { variant -> variant.outputs.all { def newName def timeNow if ("true".equals(IS_JENKINS)) { timeNow = JENKINS_TIME variant.packageApplicationProvider.get().outputDirectory = new File(project.rootDir.absolutePath + File.separator + "apks") newName = "xxx-v${APP_VERSION}-${timeNow}-${variant.buildType.name}.apk" } else { timeNow = getDate() if (variant.buildType.name.equals('debug')) { newName = "xxx-v${APP_VERSION}-debug.apk" } else { newName = "xxx-v${APP_VERSION}-${timeNow}-${variant.buildType.name}.apk" } } outputFileName = "${newName}" } } é‡åˆ°çš„å‘åœ¨jenkinsä¸­ç¼–è¯‘çš„æ—¶å€™æŠ¥é”™æ‰¾ä¸åˆ°abc_ab_share_pack_mtrl_alpha.9.pngwtfæ²¡è§è¿‡è¿™ç§é”™è¯¯å•Šï¼Œæˆ‘ä¼°æ‘¸ç€ä¼šä¸ä¼šæ˜¯è·¯å¾„å¤ªé•¿çš„åŽŸå› ï¼ŒäºŽæ˜¯åœ¨gradle.propertiesä¸­é…ç½®äº†android.buildCacheDir=F\://androidCacheï¼Œä½†æ˜¯ï¼Œå¹¶æ²¡æœ‰åµç”¨ï¼Œç§‰æ‰¿ç€ä¸è§£å†³é—®é¢˜ä¸ç½¢ä¼‘çš„æ€åº¦ï¼Œæˆ‘åˆæµªè´¹äº†ä¸€ä¸ªä¸‹åˆã€‚ç»ˆäºŽï¼Œåœ¨stackoverflowä¸Šï¼Œçœ‹åˆ°æœ‰ä¸ªå“¥ä»¬æåˆ°åœ¨jenkinsä¸­è®¾ç½®GRADLE_USER_HOMEè¿™ä¸ªçŽ¯å¢ƒå˜é‡ï¼Œéšä¾¿æŒ‡å‘ä¸€ä¸ªç›®å½•ã€‚ç„¶åŽå°±ä¸æŠ¥é”™äº†ã€‚æˆ‘çš„å†…å¿ƒæ˜¯å´©æºƒçš„ï¼Œå¥½å§ï¼Œæ€»ç®—æ˜¯è§£å†³äº†ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆAndroidStudioä¸‹ç¼–è¯‘å°±ä¸ä¼šæŠ¥é”™å‘¢ã€‚ com.sun.org.apache.xerces.internal.impl.io.MalformedByteSequenceException: 3 å­—èŠ‚çš„ UTF-8 åºåˆ—çš„å­—èŠ‚ 3 æ— æ•ˆåˆç¢°åˆ°ä¸€ä¸ªå¥‡æ€ªçš„é—®é¢˜ï¼Œè¿™ä¸ªå‘æ˜¯databindingæ¡†æž¶äº§ç”Ÿçš„ï¼Œç”±äºŽæˆ‘æ˜¯åœ¨linuxä¸Šå¼€å‘çš„ï¼ŒjenkinsçŽ¯å¢ƒéƒ¨ç½²åœ¨æœ¬åœ°çš„windowsä¸Šï¼Œåœ¨xmlä¸­databindingçš„è¡¨è¾¾å¼ä¸­å¦‚æžœå‡ºçŽ°äº†ä¸­æ–‡å­—ç¬¦ï¼Œå°±ä¼šæŠ¥ç¼–ç é”™è¯¯ï¼ŒäºŽæ˜¯æˆ‘åªèƒ½ç¡¬ç€å¤´çš®ä¿®æ”¹å¸ƒå±€æ–‡ä»¶ï¼ŒæŠŠä¸­æ–‡å­—ç¬¦ç§»åˆ°èµ„æºæ–‡ä»¶ä¸­ã€‚ å¼€å¯æ··æ·†åŽæŠ¥é”™ï¼Œproguard-rules.proæ–‡ä»¶é…ç½®å‡ºé”™Execution failed for task ':app:transformClassesAndResourcesWithProguardForRelease'. é€šè¿‡æ‰§è¡Œ gradlew --stacktrace task xxx å¯ä»¥çœ‹åˆ°å…·ä½“çš„æŠ¥é”™ä¿¡æ¯ï¼Œä¸»è¦æ˜¯ä¸èƒ½æ··æ·†çš„æ–‡ä»¶æ²¡æœ‰å¿½ç•¥æŽ‰ï¼Œé€ä¸ªå¹²æŽ‰å°±è¡Œäº†ã€‚ jenkinsä½¿ç”¨ä¸äº†ç³»ç»Ÿçš„çŽ¯å¢ƒå˜é‡é…ç½®ä¸€ä¸‹jenkinsçš„çŽ¯å¢ƒå˜é‡ç„¶åŽé‡å¯ç”Ÿæ•ˆ jenkinsæŽ§åˆ¶å°å‡ºçŽ°ä¸­æ–‡ä¹±ç jenkinsçŽ¯å¢ƒå˜é‡ä¸­æ·»åŠ  key: LANG value: zh.CH.UTF-8 å‚è€ƒç”¨apksignerè¿›è¡Œæ‰¹é‡ç­¾åçš„è„šæœ¬ä¹å›ºåŠ å›ºFAQ ç»“è¯­ä¸Šé¢è®°å½•çš„é—®é¢˜åªä¸è¿‡æ˜¯è¯¸å¤šé—®é¢˜çš„å†°å±±ä¸€è§’ï¼Œä»¥åŽæˆ‘é‡åˆ°çš„jenkinsç›¸å…³çš„é—®é¢˜éƒ½ä¼šè®°å½•äºŽæ­¤ã€‚æƒ³è¦ç†Ÿç»ƒè¿ç”¨Androidæ‰“åŒ…ï¼Œçœ‹æ ·å­è¿˜æ˜¯è¦æ·±å…¥ç ”ç©¶ä¸€ä¸‹gradleæ‰è¡Œå‘ã€‚]]></content>
      <categories>
        <category>Jenkins</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
</search>
